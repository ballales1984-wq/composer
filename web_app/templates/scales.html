{% extends "base.html" %}

{% block title %}Scale Explorer - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸŽ¼ Scale Explorer</h1>
    <p>Explore musical scales and their properties</p>
    
    <div class="help-tabs">
        <button class="tab-btn active" onclick="showHelp('theory')">ðŸ“– Teoria</button>
        <button class="tab-btn" onclick="showHelp('intervals')">ðŸŽµ Intervalli</button>
        <button class="tab-btn" onclick="showHelp('degrees')">ðŸ“Š Gradi</button>
        <button class="tab-btn" onclick="showHelp('practice')">ðŸ’ª Pratica</button>
    </div>
    
    <div id="help-theory" class="help-content">
        <div class="help-box">
            <h3>ðŸ“š Cos'Ã¨ una Scala?</h3>
            <p>Una scala Ã¨ una sequenza ordinata di note musicali organizzate per altezza. Le scale sono la base della melodia e dell'armonia nella musica occidentale.</p>
            
            <h4>ðŸŽ¯ Concetti Chiave:</h4>
            <ul>
                <li><strong>Tonica (I)</strong>: La nota base della scala - il "rifugio" sonoro</li>
                <li><strong>Modo</strong>: Il "colore" della scala (maggiore, minore, dorico, etc.)</li>
                <li><strong>Intervallo</strong>: La distanza tra due note</li>
                <li><strong>Grado</strong>: La posizione di una nota nella scala (I, II, III, etc.)</li>
            </ul>
            
            <div class="tip-box">
                <strong>ðŸ’¡ Suggerimento:</strong> La differenza tra scala maggiore e minore Ã¨ solo una questione di intervalli! La maggiore suona "allegra", la minore "malinconica".
            </div>
        </div>
    </div>
    
    <div id="help-intervals" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>ðŸŽµ Gli Intervalli</h3>
            <p>Un intervallo Ã¨ la distanza tra due note. Si misura in semitoni (mezzi toni).</p>
            
            <table class="intervals-table">
                <tr><th>Intervallo</th><th>Semitoni</th><th>Esempio</th><th>Suono</th></tr>
                <tr><td>Unisono</td><td>0</td><td>C - C</td><td>Stesso</td></tr>
                <tr><td>Seconda minore</td><td>1</td><td>C - Db</td><td>Attrito</td></tr>
                <tr><td>Seconda maggiore</td><td>2</td><td>C - D</td><td>Movimento</td></tr>
                <tr><td>Terza minore</td><td>3</td><td>C - Eb</td><td>Malinconico</td></tr>
                <tr><td>Terza maggiore</td><td>4</td><td>C - E</td><td>Allegro</td></tr>
                <tr><td>Quarta</td><td>5</td><td>C - F</td><td>Stabile</td></tr>
                <tr><td>Tritono</td><td>6</td><td>C - Gb</td><td>Instabile</td></tr>
                <tr><td>Quinta</td><td>7</td><td>C - G</td><td>Perfetto</td></tr>
                <tr><td>Sesta</td><td>9</td><td>C - A</td><td>Espansivo</td></tr>
                <tr><td>Settima</td><td>10</td><td>C - Bb</td><td>Tensione</td></tr>
                <tr><td>Ottava</td><td>12</td><td>C - C</td><td>Ritorno</td></tr>
            </table>
        </div>
    </div>
    
    <div id="help-degrees" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>ðŸ“Š I Gradi della Scala</h3>
            <p>Ogni nota della scala ha un numero (grado) e un nome che indica la sua funzione:</p>
            
            <div class="degrees-explainer">
                <div class="degree-item">
                    <span class="degree-num">I</span>
                    <div>
                        <strong>Tonica</strong>
                        <p>La nota base - il centro tonale</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">II</span>
                    <div>
                        <strong>Sopratonica</strong>
                        <p>Movimento verso la dominante</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">III</span>
                    <div>
                        <strong>Modale</strong>
                        <p>Definisce se maggiore o minore</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">IV</span>
                    <div>
                        <strong>Sottodominante</strong>
                        <p>Prepara il ritorno alla tonica</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">V</span>
                    <div>
                        <strong>Dominante</strong>
                        <p>Il grado piÃ¹ forte dopo la tonica</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">VI</span>
                    <div>
                        <strong>Sopradominante</strong>
                        <p>Funzione simmetrica alla sottodominante</p>
                    </div>
                </div>
                <div class="degree-item">
                    <span class="degree-num">VII</span>
                    <div>
                        <strong>Sensibile</strong>
                        <p>Tensione verso la tonica (mezzo tono)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="help-practice" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>ðŸ’ª Esercizi Pratici</h3>
            
            <div class="practice-tips">
                <div class="tip-card">
                    <h4>ðŸŽ¸ Pratica con la Chitarra</h4>
                    <ol>
                        <li>Suona la scala in su e giÃ¹</li>
                        <li>Cambia posizione ogni settimana</li>
                        <li>Tocca la tonica all'inizio e fine</li>
                    </ol>
                </div>
                
                <div class="tip-card">
                    <h4>ðŸ‘‚ Training Auditivo</h4>
                    <ol>
                        <li>Ascolta la "colorazione" di ogni grado</li>
                        <li>Canta i gradi dopo il pianoforte</li>
                        <li>Identifica la tonica ad occhi chiusi</li>
                    </ol>
                </div>
                
                <div class="tip-card">
                    <h4>ðŸŽ¹ Pratica al Piano</h4>
                    <ol>
                        <li>Suona le scale con mani alternate</li>
                        <li>Impara le posizioni dei Modi</li>
                        <li>Costruisci gli accordi di ogni grado</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Select Scale</h2>
        </div>
        
        <div class="form-group">
            <label class="form-label">Root Note</label>
            <select id="root-note" class="form-select">
                <option value="C">C</option>
                <option value="C#">C# / Db</option>
                <option value="D">D</option>
                <option value="D#">D# / Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F# / Gb</option>
                <option value="G">G</option>
                <option value="G#">G# / Ab</option>
                <option value="A">A</option>
                <option value="A#">A# / Bb</option>
                <option value="B">B</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Scale Type</label>
            <select id="scale-type" class="form-select">
                <optgroup label="Major & Minor">
                    <option value="major" selected>Major</option>
                    <option value="minor_natural">Natural Minor</option>
                    <option value="minor_harmonic">Harmonic Minor</option>
                    <option value="minor_melodic">Melodic Minor</option>
                </optgroup>
                <optgroup label="Modal Scales">
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="locrian">Locrian</option>
                </optgroup>
                <optgroup label="Pentatonic">
                    <option value="pentatonic_major">Major Pentatonic</option>
                    <option value="pentatonic_minor">Minor Pentatonic</option>
                </optgroup>
                <optgroup label="Blues">
                    <option value="blues_major">Major Blues</option>
                    <option value="blues_minor">Minor Blues</option>
                </optgroup>
                <optgroup label="Other">
                    <option value="whole_tone">Whole Tone</option>
                    <option value="chromatic">Chromatic</option>
                    <option value="diminished">Diminished</option>
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Octaves</label>
            <select id="octaves" class="form-select">
                <option value="1" selected>1 Octave</option>
                <option value="2">2 Octaves</option>
                <option value="3">3 Octaves</option>
            </select>
        </div>
        
        <button id="get-scale" class="btn btn-primary" style="width: 100%;">
            Get Scale Info
        </button>
        
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <a href="/fretboard" id="view-fretboard-scale" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding: 0.5rem; display: none;">
                ðŸŽ¸ View on Fretboard
            </a>
        </div>
        
        <div class="playback-controls" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button id="play-scale" class="btn btn-success" style="flex: 1;">
                â–¶ Play Scale
            </button>
            <button id="play-arpeggio" class="btn btn-secondary" style="flex: 1;">
                â™ª Play Arpeggio
            </button>
        </div>
        
        <div class="playback-settings" style="margin-top: 1rem;">
            <div class="form-group">
                <label class="form-label">Note Duration</label>
                <select id="note-duration" class="form-select">
                    <option value="0.25">Fast (250ms)</option>
                    <option value="0.5" selected>Normal (500ms)</option>
                    <option value="0.75">Slow (750ms)</option>
                    <option value="1">Very Slow (1s)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Waveform</label>
                <select id="waveform" class="form-select">
                    <option value="sine" selected>Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Scale Information</h2>
        </div>
        
        <div id="scale-result" class="result-box" style="display: none;">
            <div class="result-title">Scale Name</div>
            <div class="result-value" id="scale-name">-</div>
            
            <div class="result-title" style="margin-top: 1rem;">Notes</div>
            <div class="note-list" id="scale-notes"></div>
            
            <div class="result-title" style="margin-top: 1rem;">Intervals</div>
            <div class="note-list" id="scale-intervals"></div>
        </div>
        
        <div id="scale-error" class="result-box" style="display: none; border-color: var(--danger);">
            <p id="error-message"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">ðŸŽµ Circle of Fifths</h2>
    </div>
    
    <p style="color: var(--gray); margin-bottom: 1rem;">Click on a key to select it</p>
    
    <div class="circle-of-fifths-container">
        <svg class="circle-of-fifths" viewBox="0 0 400 400">
            <!-- Major keys (outer circle) -->
            <g class="major-keys">
                <circle-key data-root="C" cx="200" cy="50" r="35" fill="#74c0fc"></circle-key>
                <circle-key data-root="G" cx="329" cy="108" r="35" fill="#69db7c"></circle-key>
                <circle-key data-root="D" cx="371" cy="200" r="35" fill="#ffd43b"></circle-key>
                <circle-key data-root="A" cx="329" cy="292" r="35" fill="#ff8787"></circle-key>
                <circle-key data-root="E" cx="200" cy="350" r="35" fill="#da77f2"></circle-key>
                <circle-key data-root="B" cx="71" cy="292" r="35" fill="#63e6be"></circle-key>
                <circle-key data-root="F#" cx="29" cy="200" r="35" fill="#4dabf7"></circle-key>
                <circle-key data-root="Db" cx="71" cy="108" r="35" fill="#f783ac"></circle-key>
                <circle-key data-root="Ab" cx="120" cy="43" r="35" fill="#a9e34b"></circle-key>
                <circle-key data-root="Eb" cx="280" cy="43" r="35" fill="#ffc078"></circle-key>
                <circle-key data-root="Bb" cx="320" cy="157" r="35" fill="#b197fc"></circle-key>
                <circle-key data-root="F" cx="157" cy="343" r="35" fill="#38d9a9"></circle-key>
            </g>
            <!-- Minor keys (inner circle) -->
            <g class="minor-keys">
                <circle-key data-root="Am" cx="200" cy="100" r="25" fill="#e599f7"></circle-key>
                <circle-key data-root="Em" cx="285" cy="140" r="25" fill="#a5d8ff"></circle-key>
                <circle-key data-root="Bm" cx="315" cy="200" r="25" fill="#b2f2bb"></circle-key>
                <circle-key data-root="F#m" cx="285" cy="260" r="25" fill="#ffe066"></circle-key>
                <circle-key data-root="C#m" cx="200" cy="300" r="25" fill="#ffa8a8"></circle-key>
                <circle-key data-root="G#m" cx="115" cy="260" r="25" fill="#d0bfff"></circle-key>
                <circle-key data-root="D#m" cx="85" cy="200" r="25" fill="#7be9ad"></circle-key>
                <circle-key data-root="A#m" cx="115" cy="140" r="25" fill="#4dabf7"></circle-key>
                <circle-key data-root="Fm" cx="140" cy="85" r="25" fill="#f783ac"></circle-key>
                <circle-key data-root="Cm" cx="260" cy="85" r="25" fill="#a9e34b"></circle-key>
                <circle-key data-root="Gm" cx="300" cy="175" r="25" fill="#ffc078"></circle-key>
                <circle-key data-root="Dm" cx="175" cy="315" r="25" fill="#b197fc"></circle-key>
            </g>
        </svg>
    </div>
    
    <div id="circle-selection" style="margin-top: 1rem; text-align: center;">
        <span class="note-tag" id="selected-circle-note">C</span>
    </div>
</div>

<!-- Interactive Piano Keyboard -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">ðŸŽ¹ Interactive Piano</h2>
    </div>
    
    <p style="color: var(--gray); margin-bottom: 1rem;">Click on keys to play notes</p>
    
    <div class="piano-container">
        <div class="piano" id="piano-keyboard">
            <!-- White keys -->
            <div class="key white" data-note="C" data-octave="4"></div>
            <div class="key white" data-note="D" data-octave="4"></div>
            <div class="key white" data-note="E" data-octave="4"></div>
            <div class="key white" data-note="F" data-octave="4"></div>
            <div class="key white" data-note="G" data-octave="4"></div>
            <div class="key white" data-note="A" data-octave="4"></div>
            <div class="key white" data-note="B" data-octave="4"></div>
            <div class="key white" data-note="C" data-octave="5"></div>
            <!-- Black keys -->
            <div class="key black" data-note="C#" data-octave="4" style="left: 25px;"></div>
            <div class="key black" data-note="D#" data-octave="4" style="left: 75px;"></div>
            <div class="key black" data-note="F#" data-octave="4" style="left: 175px;"></div>
            <div class="key black" data-note="G#" data-octave="4" style="left: 225px;"></div>
            <div class="key black" data-note="A#" data-octave="4" style="left: 275px;"></div>
        </div>
    </div>
    
    <div class="form-group" style="margin-top: 1rem;">
        <label class="form-label">
            <input type="checkbox" id="highlight-scale" checked> Highlight scale notes
        </label>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Scale Degrees</h2>
    </div>
    
    <div id="degrees-result">
        <p>Select a scale to see degree information</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Diatonic Chords</h2>
    </div>
    
    <div id="diatonic-chords">
        <p>Select a scale to see diatonic chords</p>
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
.page-header p {
        color: var(--gray);
    }
    
    /* Educational Content Styles */
    .help-tabs {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin: 1.5rem 0;
        flex-wrap: wrap;
    }
    
    .tab-btn {
        background: rgba(30, 30, 46, 0.8);
        border: 1px solid var(--border);
        color: var(--light);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .tab-btn:hover {
        background: rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
    }
    
    .tab-btn.active {
        background: linear-gradient(135deg, #6366f1, #ec4899);
        border-color: transparent;
    }
    
    .help-content {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .help-box {
        background: linear-gradient(145deg, rgba(30, 30, 46, 0.9), rgba(30, 30, 46, 0.6));
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 16px;
        padding: 2rem;
        text-align: left;
    }
    
    .help-box h3 {
        color: var(--primary);
        margin-bottom: 1rem;
        font-size: 1.5rem;
    }
    
    .help-box h4 {
        color: var(--light);
        margin: 1.5rem 0 0.75rem;
    }
    
    .help-box ul {
        margin-left: 1.5rem;
        color: #cbd5e1;
    }
    
    .help-box li {
        margin-bottom: 0.5rem;
    }
    
    .tip-box {
        background: rgba(99, 102, 241, 0.15);
        border-left: 4px solid var(--primary);
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-top: 1.5rem;
    }
    
    .intervals-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .intervals-table th,
    .intervals-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }
    
    .intervals-table th {
        background: rgba(99, 102, 241, 0.2);
        color: var(--primary);
    }
    
    .intervals-table tr:hover {
        background: rgba(99, 102, 241, 0.1);
    }
    
    .degrees-explainer {
        display: grid;
        gap: 1rem;
    }
    
    .degree-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: rgba(15, 15, 25, 0.5);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid transparent;
        transition: all 0.3s;
    }
    
    .degree-item:hover {
        border-color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
    }
    
    .degree-num {
        background: linear-gradient(135deg, #6366f1, #ec4899);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.25rem;
    }
    
    .degree-item strong {
        color: var(--light);
        display: block;
    }
    
    .degree-item p {
        color: var(--gray);
        font-size: 0.875rem;
        margin: 0;
    }
    
    .practice-tips {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    
    .tip-card {
        background: rgba(15, 15, 25, 0.5);
        padding: 1.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
    }
    
    .tip-card h4 {
        color: var(--secondary);
        margin-bottom: 1rem;
    }
    
    .tip-card ol {
        margin-left: 1.25rem;
        color: #cbd5e1;
    }
    
    .tip-card li {
        margin-bottom: 0.5rem;
    }
    
    /* Piano Keyboard Styles */
    .piano-container {
        overflow-x: auto;
        padding: 1rem 0;
    }
    
    .piano {
        position: relative;
        display: flex;
        height: 150px;
        min-width: 500px;
    }
    
    .key {
        cursor: pointer;
        user-select: none;
        transition: all 0.1s;
    }
    
    .key.white {
        width: 50px;
        height: 150px;
        background: linear-gradient(180deg, #fff 0%, #f0f0f0 100%);
        border: 1px solid #ccc;
        border-radius: 0 0 5px 5px;
        z-index: 1;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 10px;
        font-weight: 600;
        color: #333;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .key.white:hover {
        background: linear-gradient(180deg, #f8f8f8 0%, #e8e8e8 100%);
    }
    
    .key.white:active, .key.white.playing {
        background: linear-gradient(180deg, #e0e0e0 0%, #d0d0d0 100%);
        transform: translateY(2px);
        box-shadow: 0 2px 3px rgba(0,0,0,0.1);
    }
    
    .key.black {
        position: absolute;
        width: 35px;
        height: 100px;
        background: linear-gradient(180deg, #333 0%, #111 100%);
        border-radius: 0 0 4px 4px;
        z-index: 2;
        color: white;
        font-size: 0.75rem;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 8px;
        box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    }
    
    .key.black:hover {
        background: linear-gradient(180deg, #444 0%, #222 100%);
    }
    
    .key.black:active, .key.black.playing {
        background: linear-gradient(180deg, #222 0%, #000 100%);
        transform: translateY(2px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    /* Highlight scale notes */
    .key.white.in-scale {
        background: linear-gradient(180deg, #a5d8ff 0%, #74c0fc 100%);
        border-color: var(--primary);
    }
    
    .key.black.in-scale {
        background: linear-gradient(180deg, #4dabf7 0%, #339af0 100%);
    }
    
    .key.white.root-note {
        background: linear-gradient(180deg, #b197fc 0%, #9775fa 100%);
    }
    
    .key.black.root-note {
        background: linear-gradient(180deg, #845ef7 0%, #7048e8 100%);
    }
    
    .degree-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .degree-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
    }
    
    .degree-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }
    
    .degree-note {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0.5rem 0;
    }
    
    .degree-name {
        font-size: 0.875rem;
        color: var(--gray);
    }
    
    .chord-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .chord-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
    }
    
    .chord-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--secondary);
    }
    
    .chord-notes {
        font-size: 0.875rem;
        color: var(--gray);
        margin-top: 0.5rem;
    }
    
    /* Circle of Fifths Styles */
    .circle-of-fifths-container {
        display: flex;
        justify-content: center;
        padding: 1rem;
    }
    
    .circle-of-fifths {
        width: 400px;
        height: 400px;
        max-width: 100%;
    }
    
    .circle-of-fifths circle-key {
        cursor: pointer;
        transition: transform 0.2s, filter 0.2s;
    }
    
    .circle-of-fifths circle-key:hover {
        transform: scale(1.1);
        filter: brightness(1.2);
    }
    
    .circle-of-fifths circle-key.selected {
        stroke: white;
        stroke-width: 3px;
        filter: brightness(1.3);
    }
    
    .circle-of-fifths text {
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 600;
        fill: #333;
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: middle;
    }
</style>

<script>
const rootNote = document.getElementById('root-note');
const scaleType = document.getElementById('scale-type');
const octaves = document.getElementById('octaves');
const getScaleBtn = document.getElementById('get-scale');
const highlightCheckbox = document.getElementById('highlight-scale');
const playScaleBtn = document.getElementById('play-scale');
const playArpeggioBtn = document.getElementById('play-arpeggio');
const noteDurationSelect = document.getElementById('note-duration');
const waveformSelect = document.getElementById('waveform');

// Current scale data
let currentScaleData = null;
let isPlaying = false;

// Audio context for playing notes
let audioContext = null;

// Note frequencies (A4 = 440Hz)
const noteFrequencies = {
    'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
    'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
    'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
};

function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function getFrequency(noteName) {
    // Parse note name like "C4", "F#5", "Bb3"
    const match = noteName.match(/^([A-G][#b]?)(-?\d+)?$/);
    if (!match) return 440;
    
    let note = match[1];
    const octave = match[2] ? parseInt(match[2]) : 4;
    
    // Handle enharmonic equivalents
    const noteMap = {
        'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#'
    };
    if (noteMap[note]) note = noteMap[note];
    
    const baseFreq = noteFrequencies[note];
    if (!baseFreq) return 440;
    
    return baseFreq * Math.pow(2, octave - 4);
}

function playNote(noteName, duration, waveform = 'sine') {
    initAudio();
    
    const frequency = getFrequency(noteName);
    
    // Create oscillator
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = waveform;
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    
    // ADSR Envelope
    const attack = 0.02;
    const decay = 0.05;
    const sustain = 0.7;
    const release = 0.1;
    
    const now = audioContext.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
    gainNode.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
    gainNode.gain.setValueAtTime(0.3 * sustain, now + duration - release);
    gainNode.gain.linearRampToValueAtTime(0, now + duration);
    
    oscillator.start(now);
    oscillator.stop(now + duration);
}

// Play scale sequentially
async function playScale() {
    if (!currentScaleData || isPlaying) return;
    
    isPlaying = true;
    playScaleBtn.disabled = true;
    playScaleBtn.textContent = 'â¸ Playing...';
    
    const duration = parseFloat(noteDurationSelect.value);
    const waveform = waveformSelect.value;
    
    // Get all notes from the scale
    const notes = currentScaleData.scale.notes;
    
    for (const note of notes) {
        playNote(note, duration, waveform);
        await new Promise(resolve => setTimeout(resolve, duration * 1000));
    }
    
    // Play root note again at the end
    playNote(notes[0], duration * 1.5, waveform);
    
    isPlaying = false;
    playScaleBtn.disabled = false;
    playScaleBtn.textContent = 'â–¶ Play Scale';
}

// Play arpeggio (chord tones)
async function playArpeggio() {
    if (!currentScaleData || isPlaying) return;
    
    isPlaying = true;
    playArpeggioBtn.disabled = true;
    playArpeggioBtn.textContent = 'â¸ Playing...';
    
    const duration = parseFloat(noteDurationSelect.value) * 0.8;
    const waveform = waveformSelect.value;
    
    // Get diatonic chords and play first chord as arpeggio
    try {
        const response = await fetch(`/api/scales/chords?root=${rootNote.value}&type=${scaleType.value}`);
        const data = await response.json();
        
        if (data.success && data.chords.length > 0) {
            const firstChord = data.chords[0];
            const chordNotes = firstChord.notes;
            
            // Play arpeggio (each note sequentially)
            for (const note of chordNotes) {
                playNote(note, duration, waveform);
                await new Promise(resolve => setTimeout(resolve, duration * 800));
            }
            
            // Then play all notes together (chord)
            for (const note of chordNotes) {
                playNote(note, duration * 1.5, waveform);
            }
        }
    } catch (error) {
        console.error('Error playing arpeggio:', error);
    }
    
    isPlaying = false;
    playArpeggioBtn.disabled = false;
    playArpeggioBtn.textContent = 'â™ª Play Arpeggio';
}

// Event listeners for playback buttons
playScaleBtn.addEventListener('click', playScale);
playArpeggioBtn.addEventListener('click', playArpeggio);

// Single note playback (for piano keyboard)
function playNoteOld(note, octave) {
    initAudio();
    
    const frequency = noteFrequencies[note] * Math.pow(2, octave - 4);
    
    // Create oscillator
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    
    // Envelope
    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.01);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
}

// Piano keyboard click handlers
document.querySelectorAll('.key').forEach(key => {
    key.addEventListener('click', function() {
        const note = this.dataset.note;
        const octave = parseInt(this.dataset.octave);
        const noteName = note + octave;
        
        // Visual feedback
        this.classList.add('playing');
        setTimeout(() => this.classList.remove('playing'), 150);
        
        // Play sound using the waveform selected
        const waveform = waveformSelect.value;
        playNote(noteName, parseFloat(noteDurationSelect.value), waveform);
    });
});

// Highlight scale notes on piano
function highlightPianoKeys(scaleNotes, root) {
    // Clear previous highlights
    document.querySelectorAll('.key').forEach(key => {
        key.classList.remove('in-scale', 'root-note');
    });
    
    if (!highlightCheckbox.checked) return;
    
    document.querySelectorAll('.key').forEach(key => {
        const note = key.dataset.note;
        
        // Check if note is in scale (without octave)
        if (scaleNotes.includes(note)) {
            key.classList.add('in-scale');
            
            // Highlight root note specially
            if (note === root || note === root.replace('#', '').replace('b', '')) {
                key.classList.add('root-note');
            }
        }
    });
}

// Load from URL params
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('root')) {
    rootNote.value = urlParams.get('root');
}
if (urlParams.get('type')) {
    scaleType.value = urlParams.get('type');
}

getScaleBtn.addEventListener('click', fetchScale);
highlightCheckbox.addEventListener('change', () => {
    if (window.currentScaleNotes) {
        highlightPianoKeys(window.currentScaleNotes, rootNote.value);
    }
});

async function fetchScale() {
    const root = rootNote.value;
    const type = scaleType.value;
    const oct = octaves.value;
    
    try {
        const response = await fetch(`/api/scales?root=${root}&type=${type}&octaves=${oct}`);
        const data = await response.json();
        
        if (data.success) {
            // Store current scale data for playback
            currentScaleData = data;
            
            displayScale(data.scale);
            fetchDiatonicChords(root, type);
            
            // Highlight piano keys for this scale
            window.currentScaleNotes = data.scale.notes;
            highlightPianoKeys(data.scale.notes, root);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError(error.message);
    }
}

function displayScale(scale) {
    document.getElementById('scale-result').style.display = 'block';
    document.getElementById('scale-error').style.display = 'none';
    
    document.getElementById('scale-name').textContent = scale.name;
    
    // Display notes
    const notesHtml = scale.notes.map(note => 
        `<span class="note-tag">${note}</span>`
    ).join('');
    document.getElementById('scale-notes').innerHTML = notesHtml;
    
    // Display intervals
    const intervalsHtml = scale.intervals.map(interval => 
        `<span class="note-tag">${interval}</span>`
    ).join('');
    document.getElementById('scale-intervals').innerHTML = intervalsHtml;
    
    // Display degrees
    const degreesHtml = Object.entries(scale.degrees).map(([degree, note]) => `
        <div class="degree-card">
            <div class="degree-number">${degree}</div>
            <div class="degree-note">${note}</div>
            <div class="degree-name">Degree ${degree}</div>
        </div>
    `).join('');
    document.getElementById('degrees-result').innerHTML = `
        <div class="degree-grid">${degreesHtml}</div>
    `;
    
    // Update View on Fretboard link with scale info
    const fretboardLink = document.getElementById('view-fretboard-scale');
    const root = rootNote.value;
    const type = scaleType.value;
    fretboardLink.href = `/fretboard?mode=scale&root=${root}&scale=${type}`;
    fretboardLink.style.display = 'block';
}

async function fetchDiatonicChords(root, type) {
    try {
        const response = await fetch(`/api/scales/chords?root=${root}&type=${type}`);
        const data = await response.json();
        
        if (data.success) {
            const chordsHtml = data.chords.map(chord => `
                <div class="chord-card">
                    <div class="chord-name">${chord.chord}</div>
                    <div class="chord-notes">${chord.notes.join(', ')}</div>
                </div>
            `).join('');
            document.getElementById('diatonic-chords').innerHTML = `
                <div class="chord-grid">${chordsHtml}</div>
            `;
        }
    } catch (error) {
        console.error('Error fetching diatonic chords:', error);
    }
}

function showError(message) {
    document.getElementById('scale-result').style.display = 'none';
    document.getElementById('scale-error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

// Load scale on page load if params exist
if (urlParams.get('root') || urlParams.get('type')) {
    fetchScale();
}

// Circle of Fifths functionality
function initCircleOfFifths() {
    const svg = document.querySelector('.circle-of-fifths');
    if (!svg) return;
    
    // Define note positions for Circle of Fifths
    const majorKeys = [
        { root: 'C', cx: 200, cy: 50, color: '#74c0fc' },
        { root: 'G', cx: 329, cy: 108, color: '#69db7c' },
        { root: 'D', cx: 371, cy: 200, color: '#ffd43b' },
        { root: 'A', cx: 329, cy: 292, color: '#ff8787' },
        { root: 'E', cx: 200, cy: 350, color: '#da77f2' },
        { root: 'B', cx: 71, cy: 292, color: '#63e6be' },
        { root: 'F#', cx: 29, cy: 200, color: '#4dabf7' },
        { root: 'Db', cx: 71, cy: 108, color: '#f783ac' },
        { root: 'Ab', cx: 120, cy: 43, color: '#a9e34b' },
        { root: 'Eb', cx: 280, cy: 43, color: '#ffc078' },
        { root: 'Bb', cx: 320, cy: 157, color: '#b197fc' },
        { root: 'F', cx: 157, cy: 343, color: '#38d9a9' }
    ];
    
    const minorKeys = [
        { root: 'Am', cx: 200, cy: 100, color: '#e599f7' },
        { root: 'Em', cx: 285, cy: 140, color: '#a5d8ff' },
        { root: 'Bm', cx: 315, cy: 200, color: '#b2f2bb' },
        { root: 'F#m', cx: 285, cy: 260, color: '#ffe066' },
        { root: 'C#m', cx: 200, cy: 300, color: '#ffa8a8' },
        { root: 'G#m', cx: 115, cy: 260, color: '#d0bfff' },
        { root: 'D#m', cx: 85, cy: 200, color: '#7be9ad' },
        { root: 'A#m', cx: 115, cy: 140, color: '#4dabf7' },
        { root: 'Fm', cx: 140, cy: 85, color: '#f783ac' },
        { root: 'Cm', cx: 260, cy: 85, color: '#a9e34b' },
        { root: 'Gm', cx: 300, cy: 175, color: '#ffc078' },
        { root: 'Dm', cx: 175, cy: 315, color: '#b197fc' }
    ];
    
    // Create major key circles
    const majorGroup = svg.querySelector('.major-keys');
    majorGroup.innerHTML = '';
    majorKeys.forEach(key => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'circle-key');
        g.setAttribute('data-root', key.root);
        g.style.cursor = 'pointer';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', key.cx);
        circle.setAttribute('cy', key.cy);
        circle.setAttribute('r', '30');
        circle.setAttribute('fill', key.color);
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', key.cx);
        text.setAttribute('y', key.cy);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '14');
        text.setAttribute('font-weight', '600');
        text.textContent = key.root;
        
        g.appendChild(circle);
        g.appendChild(text);
        
        g.addEventListener('click', () => selectCircleKey(key.root));
        g.addEventListener('mouseenter', () => { circle.setAttribute('r', '35'); });
        g.addEventListener('mouseleave', () => { if (!g.classList.contains('selected')) circle.setAttribute('r', '30'); });
        
        majorGroup.appendChild(g);
    });
    
    // Create minor key circles
    const minorGroup = svg.querySelector('.minor-keys');
    minorGroup.innerHTML = '';
    minorKeys.forEach(key => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'circle-key-minor');
        g.setAttribute('data-root', key.root);
        g.style.cursor = 'pointer';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', key.cx);
        circle.setAttribute('cy', key.cy);
        circle.setAttribute('r', '22');
        circle.setAttribute('fill', key.color);
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', key.cx);
        text.setAttribute('y', key.cy);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '11');
        text.setAttribute('font-weight', '600');
        text.textContent = key.root;
        
        g.appendChild(circle);
        g.appendChild(text);
        
        g.addEventListener('click', () => selectCircleKey(key.root.replace('m', ''), 'minor_natural'));
        g.addEventListener('mouseenter', () => { circle.setAttribute('r', '25'); });
        g.addEventListener('mouseleave', () => { circle.setAttribute('r', '22'); });
        
        minorGroup.appendChild(g);
    });
}

function selectCircleKey(root, scaleTypeToSet = 'major') {
    // Update root note dropdown
    rootNote.value = root;
    
    // Update scale type
    if (scaleTypeToSet === 'minor_natural') {
        scaleType.value = 'minor_natural';
    } else if (root.includes('m')) {
        scaleType.value = 'minor_natural';
    } else {
        scaleType.value = 'major';
    }
    
    // Update selection display
    document.getElementById('selected-circle-note').textContent = root;
    
    // Add visual selection
    document.querySelectorAll('.circle-key, .circle-key-minor').forEach(el => {
        const c = el.querySelector('circle');
        c.setAttribute('stroke', '#fff');
        c.setAttribute('stroke-width', '2');
        el.classList.remove('selected');
    });
    
    const selectedEl = document.querySelector(`.circle-key[data-root="${root}"], .circle-key-minor[data-root="${root}m"]`);
    if (selectedEl) {
        const c = selectedEl.querySelector('circle');
        c.setAttribute('stroke', '#333');
        c.setAttribute('stroke-width', '4');
        selectedEl.classList.add('selected');
    }
    
    // Fetch the scale
    fetchScale();
}

// Initialize Circle of Fifths on page load
document.addEventListener('DOMContentLoaded', initCircleOfFifths);

// Show help tabs function
function showHelp(tabId) {
    // Hide all help contents
    document.querySelectorAll('.help-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected content
    document.getElementById('help-' + tabId).style.display = 'block';
    
    // Add active class to clicked button
    event.target.classList.add('active');
}
</script>
{% endblock %}

