{% extends "base.html" %}

{% block title %}Real-time Analyzer - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸŽ¹ Real-time Analyzer</h1>
    <p>Play notes on the virtual keyboard or connect your MIDI controller</p>
    <div class="keyboard-guide">
        <div class="guide-section">
            <h4>ðŸŽµ PC Keyboard Layout (2 Octaves)</h4>
            <div class="guide-keys">
                <div class="guide-row">
                    <span class="guide-label">Lower Octave (C3-B3):</span>
                    <span class="key-hint">Z S X D C V G B H N J M</span>
                </div>
                <div class="guide-row">
                    <span class="guide-label">Middle Octave (C4-B4):</span>
                    <span class="key-hint">A W S E D F T G Y H U J K</span>
                </div>
                <div class="guide-row">
                    <span class="guide-label">Upper Octave (C5-C5):</span>
                    <span class="key-hint highlight">Hold SHIFT + above keys</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Virtual Keyboard</h2>
        </div>
        
        <div class="midi-status">
            <span class="status-indicator" id="midi-status"></span>
            <span id="midi-status-text">MIDI: Not connected</span>
        </div>
        
        <div class="keyboard-container">
            <div class="keyboard" id="keyboard">
                <!-- Keys generated by JavaScript -->
            </div>
        </div>
        
        <div class="keyboard-controls">
            <button id="sustain-btn" class="btn btn-secondary">Sustain</button>
            <button id="clear-btn" class="btn btn-danger">Clear All</button>
        </div>
        
        <div class="active-notes">
            <h3>Active Notes</h3>
            <div id="active-notes-display" class="note-tags"></div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Analysis Results</h2>
        </div>
        
        <div id="analysis-result">
            <p>Play some notes to see the analysis</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Detected Chord</h2>
    </div>
    
    <div id="chord-display">
        <div class="chord-name" id="chord-name">-</div>
        <div class="chord-notes" id="chord-notes"></div>
        <div class="chord-quality" id="chord-quality"></div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Suggested Scales</h2>
    </div>
    
    <div id="scales-display">
        <p>Play at least 3 notes to see suggested scales</p>
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: var(--gray);
    }
    
    .keyboard-guide {
        margin-top: 1.5rem;
        background: var(--dark);
        border-radius: 12px;
        padding: 1rem;
        display: inline-block;
    }
    
    .guide-section h4 {
        margin: 0 0 0.75rem 0;
        font-size: 1rem;
        color: var(--primary);
    }
    
    .guide-keys {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .guide-row {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .guide-label {
        font-size: 0.85rem;
        color: var(--gray);
        min-width: 150px;
        text-align: right;
    }
    
    .key-hint {
        background: var(--card-bg);
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-family: monospace;
        font-size: 0.9rem;
        letter-spacing: 1px;
    }
    
    .key-hint.highlight {
        background: var(--primary);
        color: white;
    }
    
    .midi-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: var(--dark);
        border-radius: 8px;
    }
    
    .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--danger);
    }
    
    .status-indicator.connected {
        background: var(--success);
    }
    
    .keyboard-container {
        overflow-x: auto;
        padding: 1rem 0;
        margin-bottom: 1rem;
    }
    
    .keyboard {
        display: flex;
        position: relative;
        height: 150px;
        min-width: 100%;
    }
    
    .white-key {
        width: 40px;
        height: 150px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 0 0 5px 5px;
        cursor: pointer;
        position: relative;
        z-index: 1;
    }
    
    .white-key:hover {
        background: #f0f0f0;
    }
    
    .white-key.active {
        background: var(--primary);
        box-shadow: 0 0 10px var(--primary);
    }
    
    .black-key {
        width: 30px;
        height: 90px;
        background: #333;
        position: absolute;
        z-index: 2;
        cursor: pointer;
        border-radius: 0 0 3px 3px;
    }
    
    .black-key:hover {
        background: #555;
    }
    
    .black-key.active {
        background: var(--secondary);
        box-shadow: 0 0 10px var(--secondary);
    }
    
    .key-label {
        position: absolute;
        bottom: 5px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.7rem;
        color: #666;
    }
    
    .white-key .key-label {
        color: #666;
    }
    
    .black-key .key-label {
        color: #aaa;
        font-size: 0.6rem;
    }
    
    .keyboard-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .active-notes {
        margin-top: 1rem;
    }
    
    .active-notes h3 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .note-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .note-tag {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
    }
    
    .chord-name {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        text-align: center;
        margin-bottom: 0.5rem;
    }
    
    .chord-notes {
        text-align: center;
        font-size: 1.25rem;
        color: var(--gray);
        margin-bottom: 0.25rem;
    }
    
    .chord-quality {
        text-align: center;
        font-size: 1rem;
        color: var(--secondary);
    }
    
    .scale-suggestion {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
    }
    
    .scale-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--success);
    }
    
    .scale-match {
        font-size: 0.875rem;
        color: var(--gray);
    }
    
    .scale-notes {
        margin-top: 0.5rem;
    }
    
    .analysis-section {
        margin-bottom: 1rem;
    }
    
    .analysis-label {
        font-size: 0.875rem;
        color: var(--gray);
        margin-bottom: 0.25rem;
    }
    
    .analysis-value {
        font-size: 1rem;
        font-weight: 600;
    }
</style>

<script src="/static/js/audio_manager.js"></script>
<script>
// MIDI to note name mapping
const MIDI_NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

// Active notes state
let activeNotes = new Set();
let sustainPressed = false;
let analyzeTimeout = null;

// Generate keyboard
function generateKeyboard() {
    const keyboard = document.getElementById('keyboard');
    const startNote = 48; // C3
    const endNote = 72; // C5
    
    // Create white keys first
    for (let midi = startNote; midi <= endNote; midi++) {
        const noteName = MIDI_NOTES[midi % 12];
        const isBlack = noteName.includes('#');
        
        if (!isBlack) {
            const key = document.createElement('div');
            key.className = 'white-key';
            key.dataset.midi = midi;
            key.innerHTML = `<span class="key-label">${noteName}${Math.floor(midi / 12) - 1}</span>`;
            
            // Mouse events
            key.addEventListener('mousedown', () => noteOn(midi));
            key.addEventListener('mouseup', () => noteOff(midi));
            key.addEventListener('mouseleave', () => noteOff(midi));
            
            keyboard.appendChild(key);
        }
    }
    
    // Position black keys
    const whiteKeys = keyboard.querySelectorAll('.white-key');
    const blackKeyPositions = [1, 3, 6, 8, 10]; // C#, D#, F#, G#, A#
    let whiteKeyIndex = 0;
    
    for (let midi = startNote; midi <= endNote; midi++) {
        const noteName = MIDI_NOTES[midi % 12];
        
        if (noteName.includes('#')) {
            const key = document.createElement('div');
            key.className = 'black-key';
            key.dataset.midi = midi;
            key.innerHTML = `<span class="key-label">${noteName}</span>`;
            
            // Position relative to white keys
            const position = (whiteKeyIndex * 40) - 15;
            key.style.left = `${position}px`;
            
            // Mouse events
            key.addEventListener('mousedown', () => noteOn(midi));
            key.addEventListener('mouseup', () => noteOff(midi));
            key.addEventListener('mouseleave', () => noteOff(midi));
            
            keyboard.appendChild(key);
        } else {
            whiteKeyIndex++;
        }
    }
}

// Note on
function noteOn(midi) {
    if (activeNotes.has(midi)) return;
    
    activeNotes.add(midi);
    updateKeyDisplay(midi, true);
    updateActiveNotes();
    scheduleAnalysis();
    
    // Play sound using AudioManager
    const noteName = MIDI_NOTES[midi % 12];
    const octave = Math.floor(midi / 12) - 1;
    if (audioManager) {
        audioManager.playNote(noteName, octave, 0.8, 'sine');
    }
}

// Note off
function noteOff(midi) {
    if (sustainPressed) return;
    
    activeNotes.delete(midi);
    updateKeyDisplay(midi, false);
    updateActiveNotes();
    scheduleAnalysis();
}

// Update key visual
function updateKeyDisplay(midi, active) {
    const key = document.querySelector(`.key[data-midi="${midi}"]`);
    if (key) {
        key.classList.toggle('active', active);
    }
    
    // Also find by any selector
    const allKeys = document.querySelectorAll(`[data-midi="${midi}"]`);
    allKeys.forEach(k => {
        k.classList.toggle('active', active);
    });
}

// Update active notes display
function updateActiveNotes() {
    const display = document.getElementById('active-notes-display');
    const notes = Array.from(activeNotes).sort((a, b) => a - b);
    
    display.innerHTML = notes.map(midi => {
        const noteName = MIDI_NOTES[midi % 12];
        const octave = Math.floor(midi / 12) - 1;
        return `<span class="note-tag">${noteName}${octave}</span>`;
    }).join('');
}

// Schedule analysis (debounced)
function scheduleAnalysis() {
    if (analyzeTimeout) {
        clearTimeout(analyzeTimeout);
    }
    
    analyzeTimeout = setTimeout(() => {
        performAnalysis();
    }, 100);
}

// Perform analysis
async function performAnalysis() {
    const notes = Array.from(activeNotes);
    
    if (notes.length === 0) {
        document.getElementById('analysis-result').innerHTML = '<p>Play some notes to see the analysis</p>';
        document.getElementById('chord-name').textContent = '-';
        document.getElementById('chord-notes').textContent = '';
        document.getElementById('chord-quality').textContent = '';
        document.getElementById('scales-display').innerHTML = '<p>Play at least 3 notes to see suggested scales</p>';
        return;
    }
    
    try {
        const response = await fetch('/api/analyzer/realtime/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({notes: notes})
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResults(data);
        }
    } catch (error) {
        console.error('Analysis error:', error);
    }
}

// Display results
function displayResults(data) {
    // Notes info - n.name already includes octave (e.g., "C4")
    const notesInfo = data.notes.map(n => n.name).join(', ');
    document.getElementById('analysis-result').innerHTML = `
        <div class="analysis-section">
            <div class="analysis-label">Notes Played</div>
            <div class="analysis-value">${notesInfo}</div>
        </div>
        <div class="analysis-section">
            <div class="analysis-label">Frequencies</div>
            <div class="analysis-value">${data.notes.map(n => `${n.frequency}Hz`).join(', ')}</div>
        </div>
    `;
    
    // Chord detection
    const chord = data.detected_chord;
    if (chord && chord.detected) {
        // Format chord name (add space between root and quality)
        const chordName = chord.chord.replace(/([A-G][#b]?)([A-Z])/, '$1 $2');
        document.getElementById('chord-name').textContent = chordName;
        document.getElementById('chord-notes').textContent = chord.notes.join(' - ');
        const inversionText = chord.inversion > 0 ? ` (Inversion ${chord.inversion})` : '';
        document.getElementById('chord-quality').textContent = chord.quality_name + inversionText;
    } else {
        // Handle case when chord is not detected
        if (chord && chord.note_names) {
            document.getElementById('chord-name').textContent = '?';
            document.getElementById('chord-notes').textContent = chord.note_names.join(' - ');
            document.getElementById('chord-quality').textContent = chord.reason || 'Unknown chord';
        } else {
            document.getElementById('chord-name').textContent = '-';
            document.getElementById('chord-notes').textContent = '';
            document.getElementById('chord-quality').textContent = chord ? chord.reason : '';
        }
    }
    
    // Scale suggestions
    const scales = data.suggested_scales;
    if (scales && scales.length > 0) {
        document.getElementById('scales-display').innerHTML = scales.slice(0, 5).map(scale => `
            <div class="scale-suggestion">
                <div class="scale-name">${scale.scale}</div>
                <div class="scale-match">Match: ${scale.match_score}%</div>
                <div class="scale-notes">
                    ${scale.notes.map(n => `<span class="note-tag">${n}</span>`).join('')}
                </div>
            </div>
        `).join('');
    } else {
        document.getElementById('scales-display').innerHTML = '<p>No matching scales found</p>';
    }
}

// Keyboard shortcuts - Full 2 octave range support
// Lower octave (C3-B3): z,x,c,v,b,n,m,,
// Middle octave (C4-B4): a,s,d,f,g,h,j,k,l
// Upper octave (C5-C5): shift + keys

let currentOctaveOffset = 0; // 0 = middle (C4), -1 = lower (C3), +1 = upper (C5)

document.addEventListener('keydown', (e) => {
    // Base mapping for middle octave (C4=60)
    const keyMap = {
        // Lower row - lower octave (C3-B3)
        'z': 48, 's': 49, 'x': 50, 'd': 51, 'c': 52, 
        'v': 53, 'g': 54, 'b': 55, 'h': 56, 'n': 57, 'j': 58, 'm': 59,
        // Middle row - middle octave (C4-B4)
        'a': 60, 'w': 61, 's': 62, 'e': 63, 'd': 64, 
        'f': 65, 't': 66, 'g': 67, 'y': 68, 'h': 69, 
        'u': 70, 'j': 71, 'k': 72
    };
    
    // Calculate octave offset with Shift key
    let octaveOffset = 0;
    if (e.shiftKey) {
        octaveOffset = 12; // Upper octave
    }
    
    const key = e.key.toLowerCase();
    if (keyMap[key] !== undefined && !e.repeat) {
        e.preventDefault();
        const midiNote = keyMap[key] + octaveOffset;
        // Clamp to valid range (C3-C5)
        const clampedMidi = Math.max(48, Math.min(72, midiNote));
        noteOn(clampedMidi);
    }
    
    // Space for sustain
    if (e.code === 'Space') {
        e.preventDefault();
        sustainPressed = true;
        document.getElementById('sustain-btn').classList.add('active');
    }
});

document.addEventListener('keyup', (e) => {
    // Base mapping for middle octave (C4=60)
    const keyMap = {
        // Lower row - lower octave (C3-B3)
        'z': 48, 's': 49, 'x': 50, 'd': 51, 'c': 52, 
        'v': 53, 'g': 54, 'b': 55, 'h': 56, 'n': 57, 'j': 58, 'm': 59,
        // Middle row - middle octave (C4-B4)
        'a': 60, 'w': 61, 's': 62, 'e': 63, 'd': 64, 
        'f': 65, 't': 66, 'g': 67, 'y': 68, 'h': 69, 
        'u': 70, 'j': 71, 'k': 72
    };
    
    // Calculate octave offset with Shift key
    let octaveOffset = 0;
    if (e.shiftKey) {
        octaveOffset = 12;
    }
    
    const key = e.key.toLowerCase();
    if (keyMap[key] !== undefined) {
        const midiNote = keyMap[key] + octaveOffset;
        const clampedMidi = Math.max(48, Math.min(72, midiNote));
        noteOff(clampedMidi);
    }
    
    if (e.code === 'Space') {
        sustainPressed = false;
        document.getElementById('sustain-btn').classList.remove('active');
        
        // Release all notes
        const notes = Array.from(activeNotes);
        notes.forEach(noteOff);
    }
});

// Button events
document.getElementById('sustain-btn').addEventListener('mousedown', () => {
    sustainPressed = true;
    document.getElementById('sustain-btn').classList.add('active');
});

document.getElementById('sustain-btn').addEventListener('mouseup', () => {
    sustainPressed = false;
    document.getElementById('sustain-btn').classList.remove('active');
    
    const notes = Array.from(activeNotes);
    notes.forEach(noteOff);
});

document.getElementById('clear-btn').addEventListener('click', () => {
    const notes = Array.from(activeNotes);
    notes.forEach(noteOff);
});

// MIDI support
async function initMIDI() {
    if (!navigator.requestMIDIAccess) {
        document.getElementById('midi-status-text').textContent = 'MIDI: Not supported in this browser';
        return;
    }
    
    try {
        const midi = await navigator.requestMIDIAccess();
        const inputs = midi.inputs;
        
        if (inputs.size > 0) {
            document.getElementById('midi-status').classList.add('connected');
            document.getElementById('midi-status-text').textContent = `MIDI: ${inputs.size} device(s) connected`;
            
            inputs.forEach(input => {
                input.onmidimessage = handleMIDIMessage;
            });
        } else {
            document.getElementById('midi-status-text').textContent = 'MIDI: No devices found. Connect a MIDI controller.';
        }
        
        midi.onstatechange = () => {
            const inputs = midi.inputs;
            if (inputs.size > 0) {
                document.getElementById('midi-status').classList.add('connected');
                document.getElementById('midi-status-text').textContent = `MIDI: ${inputs.size} device(s) connected`;
            } else {
                document.getElementById('midi-status').classList.remove('connected');
                document.getElementById('midi-status-text').textContent = 'MIDI: No devices connected';
            }
        };
    } catch (error) {
        document.getElementById('midi-status-text').textContent = 'MIDI: Access denied';
    }
}

function handleMIDIMessage(event) {
    const [status, note, velocity] = event.data;
    const command = status >> 4;
    
    if (command === 9 && velocity > 0) {
        noteOn(note);
    } else if (command === 8 || (command === 9 && velocity === 0)) {
        noteOff(note);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    generateKeyboard();
    initMIDI();
});
</script>
{% endblock %}

