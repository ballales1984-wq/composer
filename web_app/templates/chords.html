{% extends "base.html" %}

{% block title %}Chord Builder - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üé∏ Chord Builder</h1>
    <p>Build and explore chord voicings</p>
    
    <div class="help-tabs">
        <button class="tab-btn active" onclick="showChordHelp('theory')">üìñ Teoria</button>
        <button class="tab-btn" onclick="showChordHelp('types')">üéµ Tipi di Accordi</button>
        <button class="tab-btn" onclick="showChordHelp('voicings')">üéπ Voicing</button>
        <button class="tab-btn" onclick="showChordHelp('symbols')">üìù Simboli</button>
    </div>
    
    <div id="chord-help-theory" class="help-content">
        <div class="help-box">
            <h3>üìö Cos'√® un Accordo?</h3>
            <p>Un accordo √® un gruppo di tre o pi√π note suonate simultaneamente. Gli accordi sono la base dell'armonia nella musica.</p>
            
            <h4>üéØ Concetti Chiave:</h4>
            <ul>
                <li><strong>Fondamentale (Root)</strong>: La nota base dell'accordo</li>
                <li><strong>Triade</strong>: Le prime tre note (fondamentale, terza, quinta)</li>
                <li><strong>Qualit√†</strong>: Il "colore" dell'accordo (maggiore, minore, etc.)</li>
                <li><strong>Voicing</strong>: La disposizione delle note</li>
            </ul>
            
            <div class="tip-box">
                <strong>üí° Suggerimento:</strong> La differenza tra accordo maggiore e minore √® solo la terza! La maggiore ha terza maggiore (4 semitoni), la minore ha terza minore (3 semitoni).
            </div>
        </div>
    </div>
    
    <div id="chord-help-types" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>üéµ Tipi di Accordi</h3>
            
            <table class="chords-table">
                <tr><th>Tipo</th><th>Intervalli</th><th>Esempio</th><th>Suono</th></tr>
                <tr><td>Maggiore</td><td>1 - 3 - 5</td><td>C-E-G</td><td>Allegro, stabile</td></tr>
                <tr><td>Minore</td><td>1 - ‚ô≠3 - 5</td><td>C-Eb-G</td><td>Malinconico</td></tr>
                <tr><td>Diminuito</td><td>1 - ‚ô≠3 - ‚ô≠5</td><td>C-Eb-Gb</td><td>Tenso</td></tr>
                <tr><td>Aumentato</td><td>1 - 3 - #5</td><td>C-E-G#</td><td>Misterioso</td></tr>
                <tr><td>Sus2</td><td>1 - 2 - 5</td><td>C-D-G</td><td>Vago</td></tr>
                <tr><td>Sus4</td><td>1 - 4 - 5</td><td>C-F-G</td><td>Sospeso</td></tr>
                <tr><td>Magg7</td><td>1 - 3 - 5 - 7</td><td>C-E-G-B</td><td>Jazzy</td></tr>
                <tr><td>Dom7</td><td>1 - 3 - 5 - ‚ô≠7</td><td>C-E-G-Bb</td><td>Bluesy</td></tr>
            </table>
        </div>
    </div>
    
    <div id="chord-help-voicings" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>üéπ Voicing e Inversioni</h3>
            <p>Il voicing √® la disposizione delle note di un accordo. Puoi cambiare l'ordine delle note per creare effetti diversi.</p>
            
            <h4>üìñ Inversioni:</h4>
            <ul>
                <li><strong>Posizione Fondamentale</strong>: La nota pi√π bassa √® la fondamentale</li>
                <li><strong>Prima Inversione</strong>: La terza √® la nota pi√π bassa</li>
                <li><strong>Seconda Inversione</strong>: La quinta √® la nota pi√π bassa</li>
            </ul>
            
            <div class="tip-box">
                <strong>üí° Suggerimento:</strong> Per un suono pi√π "pieno", usa la posizione fondamentale. Per transizioni pi√π fluide tra accordi, usa le inversioni!
            </div>
        </div>
    </div>
    
    <div id="chord-help-symbols" class="help-content" style="display: none;">
        <div class="help-box">
            <h3>üìù Simboli degli Accordi</h3>
            
            <div class="symbols-grid">
                <div class="symbol-item">
                    <span class="symbol">C</span>
                    <span>Do Maggiore</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Cm</span>
                    <span>Do Minore</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">C7</span>
                    <span>Do Dominante 7</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Cmaj7</span>
                    <span>Do Maggiore 7</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Cm7</span>
                    <span>Do Minore 7</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Cdim</span>
                    <span>Do Diminuito</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Caug</span>
                    <span>Do Aumentato</span>
                </div>
                <div class="symbol-item">
                    <span class="symbol">Csus4</span>
                    <span>Do Suspended 4</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Select Chord</h2>
        </div>
        
        <div class="form-group">
            <label class="form-label">Root Note</label>
            <select id="root-note" class="form-select">
                <option value="C">C</option>
                <option value="C#">C# / Db</option>
                <option value="D">D</option>
                <option value="D#">D# / Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F# / Gb</option>
                <option value="G">G</option>
                <option value="G#">G# / Ab</option>
                <option value="A">A</option>
                <option value="A#">A# / Bb</option>
                <option value="B">B</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Chord Quality</label>
            <select id="chord-quality" class="form-select">
                <optgroup label="Triads">
                    <option value="maj" selected>Major</option>
                    <option value="min">Minor</option>
                    <option value="dim">Diminished</option>
                    <option value="aug">Augmented</option>
                </optgroup>
                <optgroup label="Suspended">
                    <option value="sus2">Suspended 2nd</option>
                    <option value="sus4">Suspended 4th</option>
                </optgroup>
                <optgroup label="Seventh Chords">
                    <option value="maj7">Major 7th</option>
                    <option value="dom7">Dominant 7th</option>
                    <option value="min7">Minor 7th</option>
                    <option value="dim7">Diminished 7th</option>
                    <option value="min7b5">Half-Diminished</option>
                    <option value="7sus4">7th Suspended 4th</option>
                </optgroup>
                <optgroup label="Extended Chords">
                    <option value="9">9th</option>
                    <option value="min9">Minor 9th</option>
                    <option value="maj9">Major 9th</option>
                    <option value="11">11th</option>
                    <option value="13">13th</option>
                </optgroup>
                <optgroup label="Added Tone">
                    <option value="6">6th</option>
                    <option value="min6">Minor 6th</option>
                    <option value="6/9">6/9</option>
                </optgroup>
            </select>
        </div>
        
<button id="get-chord" class="btn btn-primary" style="width: 100%;">
            Get Chord Info
        </button>
        
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <a href="/fretboard" id="view-fretboard-chord" class="btn btn-secondary" style="flex: 1; text-align: center; text-decoration: none; padding: 0.5rem; display: none;">
                üé∏ View on Fretboard
            </a>
        </div>
        
        <div class="playback-controls" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button id="play-chord" class="btn btn-success" style="flex: 1;">
                ‚ñ∂ Play Chord
            </button>
            <button id="play-arpeggio" class="btn btn-secondary" style="flex: 1;">
                ‚ô™ Play Arpeggio
            </button>
        </div>
        
        <div class="playback-settings" style="margin-top: 1rem;">
            <div class="form-group">
                <label class="form-label">Note Duration</label>
                <select id="note-duration" class="form-select">
                    <option value="0.5">Short (500ms)</option>
                    <option value="1" selected>Normal (1s)</option>
                    <option value="1.5">Long (1.5s)</option>
                    <option value="2">Very Long (2s)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Waveform</label>
                <select id="waveform" class="form-select">
                    <option value="sine" selected>Sine</option>
                    <option value="square">Square</option>
                    <option value="sawtooth">Sawtooth</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Chord Information</h2>
        </div>
        
        <div id="chord-result" class="result-box" style="display: none;">
            <div class="result-title">Chord Name</div>
            <div class="result-value" id="chord-name">-</div>
            
            <div class="result-title" style="margin-top: 1rem;">Notes</div>
            <div class="note-list" id="chord-notes"></div>
            
            <div class="result-title" style="margin-top: 1rem;">Intervals</div>
            <div class="note-list" id="chord-intervals"></div>
            
            <div class="result-title" style="margin-top: 1rem;">Semitones</div>
            <div class="note-list" id="chord-semitones"></div>
        </div>
        
        <div id="chord-error" class="result-box" style="display: none; border-color: var(--danger);">
            <p id="error-message"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Chord Inversions</h2>
    </div>
    
    <div id="inversions-result">
        <p>Select a chord to see inversions</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Guitar Voicing</h2>
    </div>
    
    <div class="form-group" style="margin-bottom: 1rem;">
        <label class="form-label">Voicing Mode</label>
        <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
            <label style="cursor:pointer">
                <input type="radio" name="voicing-mode" value="realistic" checked> Realistic
            </label>
            <label style="cursor:pointer">
                <input type="radio" name="voicing-mode" value="theoretical"> Theoretical
            </label>
        </div>
    </div>
    
    <div id="voicing-result">
        <p>Select a chord to see guitar voicings</p>
    </div>
</div>

<!-- Guitar Chord Diagrams Section -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üé∏ Guitar Chord Diagrams</h2>
    </div>
    
    <div id="chord-diagrams-result">
        <p>Select a chord to see chord diagrams</p>
    </div>
</div>

<!-- VexChord for chord diagrams -->
<script src="https://cdn.jsdelivr.net/npm/vexchord@0.6.4/dist/vexchord.min.js"></script>

<!-- Circle of Fifths Section -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üéµ Circolo delle Quinte</h2>
    </div>
    
    <p style="color: var(--gray); margin-bottom: 1rem;">Clicca su una tonalit√† per vedere le relazioni e gli accordi</p>
    
    <div class="circle-of-fifths-container">
        <svg class="circle-of-fifths" id="circle-of-fifths-chords" viewBox="0 0 400 400">
            <!-- Circle will be rendered by JavaScript -->
        </svg>
    </div>
    
    <div id="circle-selection" style="margin-top: 1rem; text-align: center;">
        <span class="note-tag" id="selected-circle-key" style="font-size: 1.25rem;">C</span>
        <span style="color: var(--gray); margin-left: 0.5rem;">(Tonalit√† selezionata)</span>
    </div>
    
    <!-- Key Information -->
    <div id="key-info" style="margin-top: 1.5rem; display: none;">
        <div class="grid grid-2">
            <div class="card" style="padding: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">üîó Relazioni</h3>
                <div id="key-relationships" style="font-size: 0.875rem;"></div>
            </div>
            <div class="card" style="padding: 1rem;">
                <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">üìç Tonalit√† Vicine</h3>
                <div id="key-neighbors" style="font-size: 0.875rem;"></div>
            </div>
        </div>
    </div>
    
    <!-- Diatonic Chords -->
    <div id="circle-chords" style="margin-top: 1.5rem;">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">üéπ Accordi Diatonici</h3>
        <div id="diatonic-chords-circle" class="chord-grid"></div>
    </div>
    
    <!-- Common Progressions -->
    <div id="circle-progressions" style="margin-top: 1.5rem;">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">üìú Progressioni Comuni</h3>
        <div id="common-progressions" class="progression-grid"></div>
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: var(--gray);
    }
    
    .inversion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .inversion-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
    }
    
    .inversion-position {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
    }
    
    .inversion-bass {
        font-size: 0.875rem;
        color: var(--gray);
        margin: 0.5rem 0;
    }
    
    .voicing-list {
        margin-top: 1rem;
    }
    
    .voicing-item {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .voicing-note {
        font-weight: 600;
    }

    /* Chord diagrams grid (multiple positions / inversions) */
    .chord-diagram-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .chord-diagram-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.06);
    }

    .chord-diagram-title {
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }

    .chord-diagram-subtitle {
        color: var(--gray);
        font-size: 0.85rem;
        margin-bottom: 0.75rem;
    }

    .chord-diagram-canvas {
        display: flex;
        justify-content: center;
        padding: 0.25rem 0;
        min-height: 190px;
    }
    
    /* Circle of Fifths Styles */
    .circle-of-fifths-container {
        display: flex;
        justify-content: center;
        padding: 1rem;
    }
    
    .circle-of-fifths {
        width: 400px;
        height: 400px;
        max-width: 100%;
    }
    
    .circle-key {
        cursor: pointer;
        transition: transform 0.2s, filter 0.2s;
    }
    
    .circle-key:hover circle {
        transform: scale(1.1);
        filter: brightness(1.2);
    }
    
    .circle-key.selected circle {
        stroke: white;
        stroke-width: 3px;
        filter: brightness(1.3);
    }
    
    .progression-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .progression-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .progression-card:hover {
        background: var(--primary);
        color: white;
    }
    
    .progression-name {
        font-size: 1rem;
        font-weight: 600;
    }
    
    .progression-chords {
        font-size: 0.875rem;
        color: var(--gray);
        margin-top: 0.5rem;
    }
</style>

<script>
const rootNote = document.getElementById('root-note');
const chordQuality = document.getElementById('chord-quality');
const getChordBtn = document.getElementById('get-chord');
const playChordBtn = document.getElementById('play-chord');
const playArpeggioBtn = document.getElementById('play-arpeggio');
const noteDurationSelect = document.getElementById('note-duration');
const waveformSelect = document.getElementById('waveform');

// Current chord data
let currentChordData = null;
let isPlaying = false;

// Audio context
let audioContext = null;

// Note frequencies (A4 = 440Hz)
const noteFrequencies = {
    'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
    'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
    'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
};

function initAudio() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function getFrequency(noteName) {
    const match = noteName.match(/^([A-G][#b]?)(-?\d+)?$/);
    if (!match) return 440;
    
    let note = match[1];
    const octave = match[2] ? parseInt(match[2]) : 4;
    
    const noteMap = {
        'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#'
    };
    if (noteMap[note]) note = noteMap[note];
    
    const baseFreq = noteFrequencies[note];
    if (!baseFreq) return 440;
    
    return baseFreq * Math.pow(2, octave - 4);
}

function playNote(noteName, duration, waveform = 'sine') {
    initAudio();
    
    const frequency = getFrequency(noteName);
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.type = waveform;
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    
    const attack = 0.02;
    const decay = 0.05;
    const sustain = 0.7;
    const release = 0.1;
    
    const now = audioContext.currentTime;
    gainNode.gain.setValueAtTime(0, now);
    gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
    gainNode.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
    gainNode.gain.setValueAtTime(0.3 * sustain, now + duration - release);
    gainNode.gain.linearRampToValueAtTime(0, now + duration);
    
    oscillator.start(now);
    oscillator.stop(now + duration);
}

// Play chord (all notes together)
async function playChord() {
    if (!currentChordData || isPlaying) return;
    
    isPlaying = true;
    playChordBtn.disabled = true;
    playChordBtn.textContent = '‚è∏ Playing...';
    
    const duration = parseFloat(noteDurationSelect.value);
    const waveform = waveformSelect.value;
    
    // Play all chord notes simultaneously
    for (const note of currentChordData.chord.notes) {
        playNote(note, duration, waveform);
    }
    
    // Wait for duration
    await new Promise(resolve => setTimeout(resolve, duration * 1000));
    
    isPlaying = false;
    playChordBtn.disabled = false;
    playChordBtn.textContent = '‚ñ∂ Play Chord';
}

// Play arpeggio (notes sequentially)
async function playArpeggio() {
    if (!currentChordData || isPlaying) return;
    
    isPlaying = true;
    playArpeggioBtn.disabled = true;
    playArpeggioBtn.textContent = '‚è∏ Playing...';
    
    const duration = parseFloat(noteDurationSelect.value) * 0.8;
    const waveform = waveformSelect.value;
    
    // Play each note sequentially
    for (const note of currentChordData.chord.notes) {
        playNote(note, duration, waveform);
        await new Promise(resolve => setTimeout(resolve, duration * 800));
    }
    
    // Play chord at the end
    for (const note of currentChordData.chord.notes) {
        playNote(note, duration * 1.5, waveform);
    }
    
    isPlaying = false;
    playArpeggioBtn.disabled = false;
    playArpeggioBtn.textContent = '‚ô™ Play Arpeggio';
}

// Event listeners
playChordBtn.addEventListener('click', playChord);
playArpeggioBtn.addEventListener('click', playArpeggio);

// Load from URL params
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('root')) {
    rootNote.value = urlParams.get('root');
}
if (urlParams.get('quality')) {
    chordQuality.value = urlParams.get('quality');
}

getChordBtn.addEventListener('click', fetchChord);

async function fetchChord() {
    const root = rootNote.value;
    const quality = chordQuality.value;
    
    try {
        const response = await fetch(`/api/chords?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            displayChord(data.chord);
            fetchInversions(root, quality);
            fetchVoicing(root, quality);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError(error.message);
    }
}

function displayChord(chord) {
    // Store chord data for playback
    currentChordData = { chord: chord };
    
    document.getElementById('chord-result').style.display = 'block';
    document.getElementById('chord-error').style.display = 'none';
    
    document.getElementById('chord-name').textContent = chord.name;
    
    // Display notes
    const notesHtml = chord.notes.map(note => 
        `<span class="note-tag">${note}</span>`
    ).join('');
    document.getElementById('chord-notes').innerHTML = notesHtml;
    
    // Display intervals
    const intervalsHtml = chord.intervals.map(interval => 
        `<span class="note-tag">${interval}</span>`
    ).join('');
    document.getElementById('chord-intervals').innerHTML = intervalsHtml;
    
    // Display semitones
    const semitonesHtml = chord.semitones.map(s => 
        `<span class="note-tag">${s}</span>`
    ).join('');
    document.getElementById('chord-semitones').innerHTML = semitonesHtml;
    
    // Update View on Fretboard link with chord info
    const fretboardLink = document.getElementById('view-fretboard-chord');
    const root = rootNote.value;
    const quality = chordQuality.value;
    fretboardLink.href = `/fretboard?mode=chord&root=${root}&quality=${quality}`;
    fretboardLink.style.display = 'block';
}

async function fetchInversions(root, quality) {
    try {
        const response = await fetch(`/api/chords/inversions?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            const inversionsHtml = data.inversions.map(inv => `
                <div class="inversion-card">
                    <div class="inversion-position">${inv.position === 0 ? 'Root Position' : 'Inversion ' + inv.position}</div>
                    <div class="inversion-bass">Bass: ${inv.bass}</div>
                    <div class="note-list">
                        ${inv.notes.map(n => `<span class="note-tag">${n}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('inversions-result').innerHTML = `
                <div class="inversion-grid">${inversionsHtml}</div>
            `;
        }
    } catch (error) {
        console.error('Error fetching inversions:', error);
    }
}

async function fetchVoicing(root, quality) {
    // Get selected voicing mode
    const modeRadio = document.querySelector('input[name="voicing-mode"]:checked');
    const mode = modeRadio ? modeRadio.value : 'realistic';
    
    try {
        const response = await fetch(`/api/chords/voicing?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            const voicingHtml = data.voicing.map(v => `
                <div class="voicing-item">
                    <span class="voicing-note">${v.note}</span>
                    <span>Octave ${v.octave}</span>
                </div>
            `).join('');
            document.getElementById('voicing-result').innerHTML = `
                <div class="voicing-list">${voicingHtml}</div>
            `;
        }
    } catch (error) {
        console.error('Error fetching voicing:', error);
    }
    
    // Render chord diagram with VexChord - pass mode parameter
    mostraAccordo(root, quality, mode);
}

function toVexChordFrets(frets) {
    // Convert frets array to VexChord format (reverse order: E A D G B E)
    // VexChord expects: [string6, string5, string4, string3, string2, string1]
    return frets.slice().reverse().map(f => {
        if (f === null || f === -1) return 'x';
        if (f === 0) return 'o';
        return f;
    });
}

function buildCustomChordDiagramSvg(frets, chordName, fingers) {
    const numStrings = 6;
    const numFrets = 5;
    const width = 150;
    const height = 180;
    const stringSpacing = 20;
    const fretSpacing = 25;
    const padding = 20;

    let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" 
               style="font-family: Arial, sans-serif; background: white; border-radius: 8px;">`;

    // Title
    svg += `<text x="${width/2}" y="18" text-anchor="middle" font-size="16" font-weight="bold" fill="#1a202c">${chordName}</text>`;

    const yStart = 35;
    const xStart = padding;

    // Draw nut
    svg += `<rect x="${xStart - 2}" y="${yStart}" width="${(numStrings-1)*stringSpacing + 4}" height="3" fill="#1a202c" rx="1"/>`;

    // Draw frets
    for (let i = 0; i <= numFrets; i++) {
        const y = yStart + 3 + i * fretSpacing;
        const lineWidth = i === 0 ? 2 : 1;
        const color = i === 0 ? '#1a202c' : '#cbd5e0';
        svg += `<line x1="${xStart}" y1="${y}" x2="${xStart + (numStrings-1)*stringSpacing}" y2="${y}" 
                stroke="${color}" stroke-width="${lineWidth}"/>`;
    }

    // Draw strings
    for (let i = 0; i < numStrings; i++) {
        const x = xStart + i * stringSpacing;
        svg += `<line x1="${x}" y1="${yStart}" x2="${x}" y2="${yStart + numFrets*fretSpacing}" 
                stroke="#4a5568" stroke-width="1.5"/>`;
    }

    // Draw finger positions (reverse order: E A D G B E)
    const reversedFrets = frets.slice().reverse();
    const reversedFingers = fingers ? fingers.slice().reverse() : [];

    for (let i = 0; i < numStrings; i++) {
        const x = xStart + i * stringSpacing;
        const fret = reversedFrets[i];
        const finger = reversedFingers[i] || 0;

        if (fret === null || fret === -1) {
            // Muted string
            svg += `<text x="${x}" y="${yStart - 5}" text-anchor="middle" font-size="16" font-weight="bold" fill="#718096">√ó</text>`;
        } else if (fret === 0) {
            // Open string
            svg += `<circle cx="${x}" cy="${yStart + 1.5}" r="5" fill="none" stroke="#2d3748" stroke-width="2"/>`;
        } else if (fret > 0) {
            // Fretted note
            const y = yStart + 3 + (fret - 0.5) * fretSpacing;
            svg += `<circle cx="${x}" cy="${y}" r="8" fill="#2d3748"/>`;
            if (finger > 0) {
                svg += `<text x="${x}" y="${y + 4}" text-anchor="middle" font-size="10" font-weight="bold" fill="white">${finger}</text>`;
            }
        }
    }

    // String labels
    const labels = ['E', 'A', 'D', 'G', 'B', 'E'];
    for (let i = 0; i < numStrings; i++) {
        const x = xStart + i * stringSpacing;
        svg += `<text x="${x}" y="${yStart + numFrets*fretSpacing + 18}" text-anchor="middle" 
                font-size="11" fill="#718096">${labels[i]}</text>`;
    }

    svg += '</svg>';
    return svg;
}

function renderDiagramInto(el, frets, title, fingers) {
    if (!el) return;

    // Prefer VexChord if available, fallback to SVG.
    if (typeof Vexchord !== 'undefined' && Vexchord.Chord) {
        try {
            // Ensure the target is empty and has a unique selector via id
            if (!el.id) {
                el.id = `vexchord-${Math.random().toString(36).slice(2)}`;
            }
            el.innerHTML = '';
            // VexChord 0.6.4 API: new Vexchord.Chord(selector, options)
            // eslint-disable-next-line no-unused-vars
            const chord = new Vexchord.Chord(`#${el.id}`, {
                chord: toVexChordFrets(frets),
                position: 1,
                title,
                tuning: ['E', 'A', 'D', 'G', 'B', 'E']
            });
            return;
        } catch (error) {
            console.error('VexChord error (fallback to SVG):', error);
        }
    }

    const svg = buildCustomChordDiagramSvg(frets, title, fingers);
    el.innerHTML = `<div style="display:flex;justify-content:center;">${svg}</div>`;
}

function renderInversionDiagramsFromVoicings(voicings, chordName) {
    const inversionsContainer = document.getElementById('inversions-result');
    if (!inversionsContainer) return;
    if (!Array.isArray(voicings) || voicings.length === 0) return;

    // Map voicings by inversion position (0..3)
    const invMap = new Map();
    for (const v of voicings) {
        if (typeof v?.position === 'number' && v.position >= 0 && v.position <= 3 && v.frets) {
            invMap.set(v.position, v);
        }
    }

    // Add a diagram under each inversion card if present.
    const cards = inversionsContainer.querySelectorAll('.inversion-card');
    cards.forEach((card, idx) => {
        const v = invMap.get(idx);
        if (!v) return;
        if (card.querySelector('.inversion-diagram')) return;

        const host = document.createElement('div');
        host.className = 'inversion-diagram';
        host.style.marginTop = '10px';
        card.appendChild(host);

        const title = idx === 0 ? `${chordName} (Root)` : `${chordName} (Inv ${idx})`;
        renderDiagramInto(host, v.frets, title, v.fingers);
    });
}

// Funzione per mostrare i diagrammi dell'accordo (posizioni + rivolti)
async function mostraAccordo(root, quality, mode = 'realistic') {
    const container = document.getElementById('chord-diagrams-result');
    if (!container) return;
    
    try {
        const res = await fetch(`/api/chords/positions?root=${root}&quality=${quality}&mode=${mode}`);
        const data = await res.json();
        
        if (!data.success) {
            container.innerHTML = '<p>Select a chord to see chord diagrams</p>';
            return;
        }
        
        const voicings = Array.isArray(data.voicings) ? data.voicings : [];
        if (voicings.length === 0) {
            container.innerHTML = '<p>No chord diagram available</p>';
            return;
        }
        
        const qualityMap = {
            'maj': '', 'min': 'm', 'dom7': '7', 
            'maj7': 'maj7', 'min7': 'm7', 'dim': 'dim',
            'aug': 'aug', 'sus2': 'sus2', 'sus4': 'sus4',
            'dim7': 'dim7', 'min7b5': 'm7b5'
        };
        const q = qualityMap[quality] || quality;
        const chordName = root + q;
        
        // Render grid of positions/voicings
        container.innerHTML = `
          <div class="chord-diagrams-header">
            <div style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <div>
                <h3 style="margin:0;">${chordName} ‚Äî Posizioni & Rivolti</h3>
                <p style="margin:6px 0 0;color:var(--gray);font-size:0.95rem;">
                  Mostro fino a ${voicings.length} posizioni pratiche (incluse inversioni e forme barre).
                </p>
              </div>
            </div>
          </div>
          <div class="chord-diagram-grid" id="chord-diagram-grid"></div>
        `;

        const grid = document.getElementById('chord-diagram-grid');
        const cardsHtml = voicings.map((v, idx) => `
          <div class="chord-diagram-card">
            <div class="chord-diagram-title">${v.name || `Voicing ${idx+1}`}</div>
            <div class="chord-diagram-subtitle">Frets: ${(v.frets || []).map(f => (f === null ? 'x' : f)).join(' - ')}</div>
            <div class="chord-diagram-canvas" id="chord-diagram-${idx}"></div>
          </div>
        `).join('');
        grid.innerHTML = cardsHtml;

        // Draw each diagram
        voicings.forEach((v, idx) => {
            const host = document.getElementById(`chord-diagram-${idx}`);
            const title = `${chordName} ‚Äî ${v.name || `Voicing ${idx+1}`}`;
            renderDiagramInto(host, v.frets, title, v.fingers);
        });

        // Also enrich the inversions section with diagrams (same page)
        renderInversionDiagramsFromVoicings(voicings, chordName);
    } catch (error) {
        console.error('Error showing chord diagram:', error);
        container.innerHTML = '<p>Error loading chord diagram</p>';
    }
}

// (Deprecated) kept for backward compatibility; now we render into specific hosts.
function renderCustomChordDiagram(container, frets, chordName, fingers) {
    const svg = buildCustomChordDiagramSvg(frets, chordName, fingers);
    container.innerHTML = `<div style="display:flex;justify-content:center;padding:20px;">${svg}</div>`;
}

function showError(message) {
    document.getElementById('chord-result').style.display = 'none';
    document.getElementById('chord-error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

// Load chord on page load if params exist
if (urlParams.get('root') || urlParams.get('quality')) {
    fetchChord();
}

// ============================================
// Circle of Fifths - JavaScript Functions
// ============================================

// Circle of Fifths data
const majorKeys = [
    { root: 'C', cx: 200, cy: 50, color: '#74c0fc' },
    { root: 'G', cx: 329, cy: 108, color: '#69db7c' },
    { root: 'D', cx: 371, cy: 200, color: '#ffd43b' },
    { root: 'A', cx: 329, cy: 292, color: '#ff8787' },
    { root: 'E', cx: 200, cy: 350, color: '#da77f2' },
    { root: 'B', cx: 71, cy: 292, color: '#63e6be' },
    { root: 'F#', cx: 29, cy: 200, color: '#4dabf7' },
    { root: 'Gb', cx: 71, cy: 108, color: '#f783ac' },
    { root: 'Db', cx: 120, cy: 43, color: '#a9e34b' },
    { root: 'Ab', cx: 280, cy: 43, color: '#ffc078' },
    { root: 'Eb', cx: 320, cy: 157, color: '#b197fc' },
    { root: 'Bb', cx: 157, cy: 343, color: '#38d9a9' },
    { root: 'F', cx: 200, cy: 350, color: '#38d9a9' }
];

const minorKeys = [
    { root: 'Am', cx: 200, cy: 100, color: '#e599f7' },
    { root: 'Em', cx: 285, cy: 140, color: '#a5d8ff' },
    { root: 'Bm', cx: 315, cy: 200, color: '#b2f2bb' },
    { root: 'F#m', cx: 285, cy: 260, color: '#ffe066' },
    { root: 'C#m', cx: 200, cy: 300, color: '#ffa8a8' },
    { root: 'G#m', cx: 115, cy: 260, color: '#d0bfff' },
    { root: 'D#m', cx: 85, cy: 200, color: '#7be9ad' },
    { root: 'A#m', cx: 115, cy: 140, color: '#4dabf7' },
    { root: 'Fm', cx: 140, cy: 85, color: '#f783ac' },
    { root: 'Cm', cx: 260, cy: 85, color: '#a9e34b' },
    { root: 'Gm', cx: 300, cy: 175, color: '#ffc078' },
    { root: 'Dm', cx: 175, cy: 315, color: '#b197fc' }
];

let currentSelectedKey = 'C';

function initCircleOfFifths() {
    const svg = document.getElementById('circle-of-fifths-chords');
    if (!svg) return;
    
    // Clear SVG
    svg.innerHTML = '';
    
    // Create main group for major keys (outer circle)
    const majorGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    majorGroup.setAttribute('class', 'major-keys');
    svg.appendChild(majorGroup);
    
    majorKeys.forEach(key => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'circle-key');
        g.setAttribute('data-root', key.root);
        g.style.cursor = 'pointer';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', key.cx);
        circle.setAttribute('cy', key.cy);
        circle.setAttribute('r', '30');
        circle.setAttribute('fill', key.color);
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', key.cx);
        text.setAttribute('y', key.cy);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '14');
        text.setAttribute('font-weight', '600');
        text.textContent = key.root;
        
        g.appendChild(circle);
        g.appendChild(text);
        
        g.addEventListener('click', () => selectCircleKey(key.root));
        g.addEventListener('mouseenter', () => { circle.setAttribute('r', '35'); });
        g.addEventListener('mouseleave', () => { circle.setAttribute('r', '30'); });
        
        majorGroup.appendChild(g);
    });
    
    // Create minor keys group (inner circle)
    const minorGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    minorGroup.setAttribute('class', 'minor-keys');
    svg.appendChild(minorGroup);
    
    minorKeys.forEach(key => {
        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('class', 'circle-key circle-key-minor');
        g.setAttribute('data-root', key.root);
        g.style.cursor = 'pointer';
        
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', key.cx);
        circle.setAttribute('cy', key.cy);
        circle.setAttribute('r', '22');
        circle.setAttribute('fill', key.color);
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', key.cx);
        text.setAttribute('y', key.cy);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', '#333');
        text.setAttribute('font-size', '11');
        text.setAttribute('font-weight', '600');
        text.textContent = key.root;
        
        g.appendChild(circle);
        g.appendChild(text);
        
        const rootNote = key.root.replace('m', '');
        g.addEventListener('click', () => selectCircleKey(rootNote, 'minor'));
        g.addEventListener('mouseenter', () => { circle.setAttribute('r', '25'); });
        g.addEventListener('mouseleave', () => { circle.setAttribute('r', '22'); });
        
        minorGroup.appendChild(g);
    });
    
    // Load default key
    selectCircleKey('C');
}

async function selectCircleKey(root, type = 'major') {
    currentSelectedKey = root;
    
    // Update display
    document.getElementById('selected-circle-key').textContent = root;
    
    // Update visual selection
    document.querySelectorAll('.circle-key').forEach(el => {
        const circle = el.querySelector('circle');
        circle.setAttribute('stroke', '#fff');
        circle.setAttribute('stroke-width', '2');
        el.classList.remove('selected');
    });
    
    const selectedEl = document.querySelector(`.circle-key[data-root="${root}"]`);
    if (selectedEl) {
        const circle = selectedEl.querySelector('circle');
        circle.setAttribute('stroke', '#333');
        circle.setAttribute('stroke-width', '4');
        selectedEl.classList.add('selected');
    }
    
    // Fetch key info from API
    try {
        const response = await fetch(`/api/circle/key/${root}`);
        const data = await response.json();
        
        if (data.success) {
            displayKeyInfo(data);
        }
    } catch (error) {
        console.error('Error fetching key info:', error);
    }
}

function displayKeyInfo(data) {
    const keyInfo = document.getElementById('key-info');
    keyInfo.style.display = 'block';
    
    // Display relationships
    const relationshipsDiv = document.getElementById('key-relationships');
    const keyData = data.key;
    const rel = data.relative_key;
    
    relationshipsDiv.innerHTML = `
        <div style="margin-bottom: 0.5rem;">
            <strong>Relative ${rel.type}:</strong> 
            <span class="note-tag">${rel.key}</span>
        </div>
    `;
    
    // Display neighbors
    const neighborsDiv = document.getElementById('key-neighbors');
    fetchNeighbors(currentSelectedKey);
    
    // Display diatonic chords
    displayDiatonicChords(data.diatonic_chords);
    
    // Display common progressions
    displayCommonProgressions(data.common_progressions);
}

async function fetchNeighbors(root) {
    try {
        const response = await fetch(`/api/circle/neighbors/${root}`);
        const data = await response.json();
        
        if (data.success) {
            const neighborsDiv = document.getElementById('key-neighbors');
            neighborsDiv.innerHTML = `
                <div style="margin-bottom: 0.5rem;">
                    <strong>‚Üê Sottodominante:</strong> 
                    <span class="note-tag">${data.neighbors.counter_clockwise}</span>
                </div>
                <div>
                    <strong>Dominante ‚Üí:</strong> 
                    <span class="note-tag">${data.neighbors.clockwise}</span>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error fetching neighbors:', error);
    }
}

function displayDiatonicChords(chords) {
    const container = document.getElementById('diatonic-chords-circle');
    
    const chordsHtml = chords.map(chord => `
        <div class="chord-card">
            <div class="chord-name">${chord.roman || chord.degree}</div>
            <div class="chord-notes">${chord.chord}</div>
            <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">
                ${chord.notes.join(' - ')}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = chordsHtml;
}

function displayCommonProgressions(progressions) {
    const container = document.getElementById('common-progressions');
    
    const progressionsHtml = progressions.map(prog => `
        <div class="progression-card" onclick="playProgression('${prog.chords.join(',')}')">
            <div class="progression-name">${prog.name}</div>
            <div class="progression-chords">${prog.description}</div>
            <div style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.8;">
                ${prog.chords.join(' - ')}
            </div>
        </div>
    `).join('');
    
    container.innerHTML = progressionsHtml;
}

function playProgression(chordNames) {
    // Simple progression playback - plays each chord for 1 second
    const chords = chordNames.split(',');
    const root = currentSelectedKey;
    
    // Map roman numerals to actual chords (simplified)
    const romanMap = {
        'I': 'maj', 'i': 'min',
        'II': 'maj', 'ii': 'min',
        'III': 'maj', 'iii': 'min',
        'IV': 'maj', 'iv': 'min',
        'V': 'maj', 'v': 'min',
        'VI': 'maj', 'vi': 'min',
        'VII': 'dim', 'vii': 'dim'
    };
    
    // This is a simplified version - in a real app you'd map properly
    initAudio();
    const waveform = waveformSelect ? waveformSelect.value : 'sine';
    
    // Play a simple chord for demo
    playNote(root + '4', 1, waveform);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initCircleOfFifths);
</script>
{% endblock %}

