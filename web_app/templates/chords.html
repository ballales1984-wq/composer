{% extends "base.html" %}

{% block title %}Chord Builder - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸŽ¸ Chord Builder</h1>
    <p>Build and explore chord voicings</p>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Select Chord</h2>
        </div>
        
        <div class="form-group">
            <label class="form-label">Root Note</label>
            <select id="root-note" class="form-select">
                <option value="C">C</option>
                <option value="C#">C# / Db</option>
                <option value="D">D</option>
                <option value="D#">D# / Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F# / Gb</option>
                <option value="G">G</option>
                <option value="G#">G# / Ab</option>
                <option value="A">A</option>
                <option value="A#">A# / Bb</option>
                <option value="B">B</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Chord Quality</label>
            <select id="chord-quality" class="form-select">
                <optgroup label="Triads">
                    <option value="maj" selected>Major</option>
                    <option value="min">Minor</option>
                    <option value="dim">Diminished</option>
                    <option value="aug">Augmented</option>
                </optgroup>
                <optgroup label="Suspended">
                    <option value="sus2">Suspended 2nd</option>
                    <option value="sus4">Suspended 4th</option>
                </optgroup>
                <optgroup label="Seventh Chords">
                    <option value="maj7">Major 7th</option>
                    <option value="dom7">Dominant 7th</option>
                    <option value="min7">Minor 7th</option>
                    <option value="dim7">Diminished 7th</option>
                    <option value="min7b5">Half-Diminished</option>
                    <option value="7sus4">7th Suspended 4th</option>
                </optgroup>
                <optgroup label="Extended Chords">
                    <option value="9">9th</option>
                    <option value="min9">Minor 9th</option>
                    <option value="maj9">Major 9th</option>
                    <option value="11">11th</option>
                    <option value="13">13th</option>
                </optgroup>
                <optgroup label="Added Tone">
                    <option value="6">6th</option>
                    <option value="min6">Minor 6th</option>
                    <option value="6/9">6/9</option>
                </optgroup>
            </select>
        </div>
        
        <button id="get-chord" class="btn btn-primary" style="width: 100%;">
            Get Chord Info
        </button>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Chord Information</h2>
        </div>
        
        <div id="chord-result" class="result-box" style="display: none;">
            <div class="result-title">Chord Name</div>
            <div class="result-value" id="chord-name">-</div>
            
            <div class="result-title" style="margin-top: 1rem;">Notes</div>
            <div class="note-list" id="chord-notes"></div>
            
            <div class="result-title" style="margin-top: 1rem;">Intervals</div>
            <div class="note-list" id="chord-intervals"></div>
            
            <div class="result-title" style="margin-top: 1rem;">Semitones</div>
            <div class="note-list" id="chord-semitones"></div>
        </div>
        
        <div id="chord-error" class="result-box" style="display: none; border-color: var(--danger);">
            <p id="error-message"></p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Chord Inversions</h2>
    </div>
    
    <div id="inversions-result">
        <p>Select a chord to see inversions</p>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Guitar Voicing</h2>
    </div>
    
    <div id="voicing-result">
        <p>Select a chord to see guitar voicings</p>
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: var(--gray);
    }
    
    .inversion-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .inversion-card {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
    }
    
    .inversion-position {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--primary);
    }
    
    .inversion-bass {
        font-size: 0.875rem;
        color: var(--gray);
        margin: 0.5rem 0;
    }
    
    .voicing-list {
        margin-top: 1rem;
    }
    
    .voicing-item {
        background: var(--dark);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .voicing-note {
        font-weight: 600;
    }
</style>

<script>
const rootNote = document.getElementById('root-note');
const chordQuality = document.getElementById('chord-quality');
const getChordBtn = document.getElementById('get-chord');

// Load from URL params
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('root')) {
    rootNote.value = urlParams.get('root');
}
if (urlParams.get('quality')) {
    chordQuality.value = urlParams.get('quality');
}

getChordBtn.addEventListener('click', fetchChord);

async function fetchChord() {
    const root = rootNote.value;
    const quality = chordQuality.value;
    
    try {
        const response = await fetch(`/api/chords?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            displayChord(data.chord);
            fetchInversions(root, quality);
            fetchVoicing(root, quality);
        } else {
            showError(data.error);
        }
    } catch (error) {
        showError(error.message);
    }
}

function displayChord(chord) {
    document.getElementById('chord-result').style.display = 'block';
    document.getElementById('chord-error').style.display = 'none';
    
    document.getElementById('chord-name').textContent = chord.name;
    
    // Display notes
    const notesHtml = chord.notes.map(note => 
        `<span class="note-tag">${note}</span>`
    ).join('');
    document.getElementById('chord-notes').innerHTML = notesHtml;
    
    // Display intervals
    const intervalsHtml = chord.intervals.map(interval => 
        `<span class="note-tag">${interval}</span>`
    ).join('');
    document.getElementById('chord-intervals').innerHTML = intervalsHtml;
    
    // Display semitones
    const semitonesHtml = chord.semitones.map(s => 
        `<span class="note-tag">${s}</span>`
    ).join('');
    document.getElementById('chord-semitones').innerHTML = semitonesHtml;
}

async function fetchInversions(root, quality) {
    try {
        const response = await fetch(`/api/chords/inversions?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            const inversionsHtml = data.inversions.map(inv => `
                <div class="inversion-card">
                    <div class="inversion-position">${inv.position === 0 ? 'Root Position' : 'Inversion ' + inv.position}</div>
                    <div class="inversion-bass">Bass: ${inv.bass}</div>
                    <div class="note-list">
                        ${inv.notes.map(n => `<span class="note-tag">${n}</span>`).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('inversions-result').innerHTML = `
                <div class="inversion-grid">${inversionsHtml}</div>
            `;
        }
    } catch (error) {
        console.error('Error fetching inversions:', error);
    }
}

async function fetchVoicing(root, quality) {
    try {
        const response = await fetch(`/api/chords/voicing?root=${root}&quality=${quality}`);
        const data = await response.json();
        
        if (data.success) {
            const voicingHtml = data.voicing.map(v => `
                <div class="voicing-item">
                    <span class="voicing-note">${v.note}</span>
                    <span>Octave ${v.octave}</span>
                </div>
            `).join('');
            document.getElementById('voicing-result').innerHTML = `
                <div class="voicing-list">${voicingHtml}</div>
            `;
        }
    } catch (error) {
        console.error('Error fetching voicing:', error);
    }
}

function showError(message) {
    document.getElementById('chord-result').style.display = 'none';
    document.getElementById('chord-error').style.display = 'block';
    document.getElementById('error-message').textContent = message;
}

// Load chord on page load if params exist
if (urlParams.get('root') || urlParams.get('quality')) {
    fetchChord();
}
</script>
{% endblock %}

