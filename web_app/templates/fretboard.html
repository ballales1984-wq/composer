{% extends "base.html" %}

{% block title %}Fretboard Visualization - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>ðŸŽ¹ Guitar Fretboard</h1>
    <p>Visualize notes on the guitar fretboard</p>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Select Notes to Display</h2>
    </div>
    
    <div class="form-group">
        <label class="form-label">Root Note</label>
        <select id="root-note" class="form-select">
            <option value="C">C</option>
            <option value="C#">C# / Db</option>
            <option value="D">D</option>
            <option value="D#">D# / Eb</option>
            <option value="E">E</option>
            <option value="F">F</option>
            <option value="F#">F# / Gb</option>
            <option value="G">G</option>
            <option value="G#">G# / Ab</option>
            <option value="A">A</option>
            <option value="A#">A# / Bb</option>
            <option value="B">B</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">Display Mode</label>
        <select id="display-mode" class="form-select">
            <option value="scale">Scale Notes</option>
            <option value="chord">Chord Notes</option>
            <option value="all">All Notes</option>
        </select>
    </div>
    
    <div id="scale-options" class="form-group">
        <label class="form-label">Scale Type</label>
        <select id="scale-type" class="form-select">
            <option value="major">Major</option>
            <option value="minor_natural">Natural Minor</option>
            <option value="dorian">Dorian</option>
            <option value="mixolydian">Mixolydian</option>
        </select>
    </div>
    
    <div id="chord-options" class="form-group" style="display: none;">
        <label class="form-label">Chord Quality</label>
        <select id="chord-quality" class="form-select">
            <option value="maj">Major</option>
            <option value="min">Minor</option>
            <option value="dom7">Dominant 7th</option>
            <option value="maj7">Major 7th</option>
            <option value="min7">Minor 7th</option>
        </select>
    </div>
    
    <button id="display-btn" class="btn btn-primary">
        Display on Fretboard
    </button>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Fretboard</h2>
    </div>
    
    <div id="fretboard-container">
        <div class="fretboard">
            <div class="string" data-string="6">
                <span class="string-name">E</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}">
                    {% if fret == 0 %}<span class="fret-marker">â—‹</span>{% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="string" data-string="5">
                <span class="string-name">A</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}"></div>
                {% endfor %}
            </div>
            <div class="string" data-string="4">
                <span class="string-name">D</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}"></div>
                {% endfor %}
            </div>
            <div class="string" data-string="3">
                <span class="string-name">G</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}"></div>
                {% endfor %}
            </div>
            <div class="string" data-string="2">
                <span class="string-name">B</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}"></div>
                {% endfor %}
            </div>
            <div class="string" data-string="1">
                <span class="string-name">e</span>
                {% for fret in range(13) %}
                <div class="fret" data-fret="{{ fret }}"></div>
                {% endfor %}
            </div>
        </div>
        
        <div class="fret-numbers">
            <div></div>
            {% for fret in range(13) %}
            <div class="fret-number">{{ fret }}</div>
            {% endfor %}
        </div>
    </div>
    
    <div id="note-legend" style="margin-top: 1rem;">
        <div class="legend-title">Notes:</div>
        <div class="note-list" id="displayed-notes"></div>
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .page-header p {
        color: var(--gray);
    }
    
    .fretboard {
        background: linear-gradient(180deg, #8B4513 0%, #654321 100%);
        border-radius: 8px;
        padding: 1rem;
        overflow-x: auto;
    }
    
    .string {
        display: flex;
        align-items: center;
        height: 40px;
        position: relative;
    }
    
    .string::before {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: calc(2px + var(--string-number, 3px) * 0.5px);
        background: linear-gradient(90deg, #c0c0c0, #e8e8e8);
        transform: translateY(-50%);
    }
    
    .string[data-string="6"] { --string-number: 6; }
    .string[data-string="5"] { --string-number: 5; }
    .string[data-string="4"] { --string-number: 4; }
    .string[data-string="3"] { --string-number: 3; }
    .string[data-string="2"] { --string-number: 2; }
    .string[data-string="1"] { --string-number: 1; }
    
    .string-name {
        width: 30px;
        font-weight: 600;
        color: var(--light);
        z-index: 1;
    }
    
    .fret {
        width: 50px;
        height: 40px;
        border-right: 3px solid #444;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }
    
    .fret:first-child {
        border-right: 5px solid #666;
        background: rgba(255,255,255,0.1);
    }
    
    .fret-marker {
        font-size: 1.25rem;
    }
    
    .fret-number {
        text-align: center;
        padding: 0.5rem;
        color: var(--gray);
        font-size: 0.875rem;
    }
    
    .fret-numbers {
        display: flex;
        padding-left: 30px;
    }
    
    .fret-numbers > div {
        width: 50px;
    }
    
    .fret-numbers > div:first-child {
        width: 30px;
    }
    
    .fret .note {
        background: var(--primary);
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        z-index: 2;
    }
    
    .fret .note.root {
        background: var(--secondary);
    }
    
    .legend-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    @media (max-width: 768px) {
        .fret {
            width: 40px;
        }
        
        .fret-numbers > div {
            width: 40px;
        }
    }
</style>

<script>
const displayMode = document.getElementById('display-mode');
const scaleOptions = document.getElementById('scale-options');
const chordOptions = document.getElementById('chord-options');
const displayBtn = document.getElementById('display-btn');

// Note positions on fretboard (standard tuning)
const stringTuning = ['E', 'A', 'D', 'G', 'B', 'e'];

// All notes in chromatic order
const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

displayMode.addEventListener('change', () => {
    if (displayMode.value === 'scale') {
        scaleOptions.style.display = 'block';
        chordOptions.style.display = 'none';
    } else if (displayMode.value === 'chord') {
        scaleOptions.style.display = 'none';
        chordOptions.style.display = 'block';
    } else {
        scaleOptions.style.display = 'none';
        chordOptions.style.display = 'none';
    }
});

displayBtn.addEventListener('click', displayFretboard);

function getNoteForFret(stringIndex, fret) {
    const openNote = stringTuning[stringIndex];
    const openIndex = chromaticNotes.indexOf(openNote);
    const noteIndex = (openIndex + fret) % 12;
    return chromaticNotes[noteIndex];
}

function getNotesForScale(root, scaleType) {
    const scaleNotes = [];
    
    // Scale intervals
    const intervals = {
        major: [0, 2, 4, 5, 7, 9, 11],
        minor_natural: [0, 2, 3, 5, 7, 8, 10],
        dorian: [0, 2, 3, 5, 7, 9, 10],
        mixolydian: [0, 2, 4, 5, 7, 9, 10],
        phrygian: [0, 1, 3, 5, 7, 8, 10],
        lydian: [0, 2, 4, 6, 7, 9, 11],
        locrian: [0, 1, 3, 5, 6, 8, 10]
    };
    
    const rootIndex = chromaticNotes.indexOf(root);
    const scaleIntervals = intervals[scaleType] || intervals.major;
    
    scaleIntervals.forEach(interval => {
        const noteIndex = (rootIndex + interval) % 12;
        scaleNotes.push(chromaticNotes[noteIndex]);
    });
    
    return scaleNotes;
}

function getNotesForChord(root, quality) {
    const chordNotes = [];
    
    // Chord intervals
    const intervals = {
        maj: [0, 4, 7],
        min: [0, 3, 7],
        dom7: [0, 4, 7, 10],
        maj7: [0, 4, 7, 11],
        min7: [0, 3, 7, 10]
    };
    
    const rootIndex = chromaticNotes.indexOf(root);
    const chordIntervals = intervals[quality] || intervals.maj;
    
    chordIntervals.forEach(interval => {
        const noteIndex = (rootIndex + interval) % 12;
        chordNotes.push(chromaticNotes[noteIndex]);
    });
    
    return chordNotes;
}

async function displayFretboard() {
    const root = document.getElementById('root-note').value;
    const mode = displayMode.value;
    
    let activeNotes = [];
    
    if (mode === 'scale') {
        const scaleType = document.getElementById('scale-type').value;
        activeNotes = getNotesForScale(root, scaleType);
    } else if (mode === 'chord') {
        const chordQuality = document.getElementById('chord-quality').value;
        activeNotes = getNotesForChord(root, chordQuality);
    } else {
        activeNotes = [...chromaticNotes];
    }
    
    // Clear previous notes
    document.querySelectorAll('.fret .note').forEach(note => note.remove());
    
    // Add notes to fretboard
    const strings = document.querySelectorAll('.string');
    strings.forEach((stringEl, stringIndex) => {
        const frets = stringEl.querySelectorAll('.fret');
        frets.forEach((fretEl, fretIndex) => {
            const note = getNoteForFret(stringIndex, fretIndex);
            if (activeNotes.includes(note)) {
                const noteEl = document.createElement('span');
                noteEl.className = 'note';
                noteEl.textContent = note;
                if (note === root) {
                    noteEl.classList.add('root');
                }
                fretEl.appendChild(noteEl);
            }
        });
    });
    
    // Update legend
    const notesHtml = activeNotes.map(n => 
        `<span class="note-tag" ${n === root ? 'style="background: var(--secondary);"' : ''}>${n}</span>`
    ).join('');
    document.getElementById('displayed-notes').innerHTML = notesHtml;
}
</script>
{% endblock %}

