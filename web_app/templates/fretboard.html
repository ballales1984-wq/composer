{% extends "base.html" %}

{% block title %}Fretboard Visualization - Music Theory Engine{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üé∏ Guitar Fretboard</h1>
    <p>Visualize notes, scales, and chords on the guitar fretboard</p>
</div>

<div class="controls-grid">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Settings</h3>
        </div>
        
        <div class="form-group">
            <label class="form-label">Root Note</label>
            <select id="root-note" class="form-select">
                <option value="C">C</option>
                <option value="C#">C# / Db</option>
                <option value="D">D</option>
                <option value="D#">D# / Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F# / Gb</option>
                <option value="G">G</option>
                <option value="G#">G# / Ab</option>
                <option value="A">A</option>
                <option value="A#">A# / Bb</option>
                <option value="B">B</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Display Mode</label>
            <select id="display-mode" class="form-select">
                <option value="scale">Scale</option>
                <option value="chord">Chord</option>
                <option value="scale_chord">Scale + Chord</option>
                <option value="all">All Notes</option>
            </select>
        </div>
        
        <div id="scale-options" class="form-group">
            <label class="form-label">Scale Type</label>
            <select id="scale-type" class="form-select">
                <optgroup label="Major/Minor">
                    <option value="major" selected>Major</option>
                    <option value="minor_natural">Natural Minor</option>
                    <option value="minor_harmonic">Harmonic Minor</option>
                    <option value="minor_melodic">Melodic Minor</option>
                </optgroup>
                <optgroup label="Modes">
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="locrian">Locrian</option>
                </optgroup>
                <optgroup label="Pentatonic">
                    <option value="pentatonic_major">Major Pentatonic</option>
                    <option value="pentatonic_minor">Minor Pentatonic</option>
                </optgroup>
                <optgroup label="Blues">
                    <option value="blues_minor">Blues Minor</option>
                    <option value="blues_major">Blues Major</option>
                </optgroup>
            </select>
        </div>
        
        <div id="chord-options" class="form-group" style="display: none;">
            <label class="form-label">Chord Quality</label>
            <select id="chord-quality" class="form-select">
                <optgroup label="Triads">
                    <option value="maj">Major</option>
                    <option value="min">Minor</option>
                    <option value="dim">Diminished</option>
                    <option value="aug">Augmented</option>
                </optgroup>
                <optgroup label="Seventh Chords">
                    <option value="dom7">Dominant 7th</option>
                    <option value="maj7">Major 7th</option>
                    <option value="min7">Minor 7th</option>
                    <option value="dim7">Diminished 7th</option>
                    <option value="min7b5">Half-Diminished</option>
                </optgroup>
                <optgroup label="Extended">
                    <option value="9">9th</option>
                    <option value="maj9">Major 9th</option>
                    <option value="min9">Minor 9th</option>
                    <option value="11">11th</option>
                    <option value="13">13th</option>
                </optgroup>
            </select>
        </div>
        
        <!-- Chord Root for Scale + Chord mode -->
        <div id="chord-root-options" class="form-group" style="display: none;">
            <label class="form-label">Chord Root Note</label>
            <select id="chord-root-note" class="form-select">
                <option value="C">C</option>
                <option value="C#">C# / Db</option>
                <option value="D">D</option>
                <option value="D#">D# / Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="F#">F# / Gb</option>
                <option value="G" selected>G</option>
                <option value="G#">G# / Ab</option>
                <option value="A">A</option>
                <option value="A#">A# / Bb</option>
                <option value="B">B</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Number of Frets</label>
            <select id="num-frets" class="form-select">
                <option value="12">12 Frets (1 Octave)</option>
                <option value="15" selected>15 Frets</option>
                <option value="24">24 Frets (Full)</option>
            </select>
        </div>
        
<div class="form-group">
            <label class="form-label">Tuning</label>
            <select id="tuning" class="form-select">
                <option value="standard" selected>Standard (EADGBe)</option>
                <option value="drop_d">Drop D (DADGBe)</option>
                <option value="open_g">Open G (DGDGBD)</option>
                <option value="open_d">Open D (DADF#AD)</option>
                <option value="half_step">Half Step Down</option>
                <option value="full_step">Full Step Down</option>
            </select>
        </div>
        
        <!-- Audio Settings - Fixed to triangle waveform, 1 second duration -->
        <div class="form-group">
            <label class="form-label">üéµ Sound: Triangle (Mellow)</label>
            <input type="hidden" id="waveform" value="triangle">
        </div>
        
        <div class="form-group">
            <label class="form-label">‚è± Duration: 1 second</label>
            <input type="hidden" id="note-duration" value="1">
        </div>
        
        <button id="display-btn" class="btn btn-primary btn-block">
            Display Fretboard
        </button>
        
        <button id="play-scale-btn" class="btn btn-success btn-block" style="margin-top: 0.75rem;">
            ‚ñ∂ Play Scale
        </button>
        
        <button id="play-chord-btn" class="btn btn-warning btn-block" style="margin-top: 0.75rem;">
            üéµ Highlight Chord (MIDI)
        </button>
        
        <button id="stop-scale-btn" class="btn btn-danger btn-block" style="margin-top: 0.5rem; display: none;">
            ‚èπ Stop
        </button>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Legend</h3>
        </div>
        
        <div class="legend-content">
            <div class="legend-item">
                <span class="legend-color root-note"></span>
                <span>Root Note</span>
            </div>
            <div class="legend-item">
                <span class="legend-color scale-note"></span>
                <span>Scale Note</span>
            </div>
            <div class="legend-item">
                <span class="legend-color chord-note"></span>
                <span>Chord Tone</span>
            </div>
            <div class="legend-item" id="common-legend-item" style="display: none;">
                <span class="legend-color common-note"></span>
                <span>Common (Scale + Chord)</span>
            </div>
        </div>
        
        <div class="legend-title" style="margin-top: 1rem;">Active Notes:</div>
        <div class="note-tags" id="displayed-notes"></div>
        
        <div class="legend-title" style="margin-top: 1rem;">Tuning Info:</div>
        <div id="tuning-info" style="color: var(--gray); font-size: 0.875rem;">
            Standard: E A D G B e
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Fretboard</h2>
    </div>
    
    <div class="fretboard-container" id="fretboard-container">
        <!-- Professional SVG fretboard rendered here -->
    </div>
</div>

<style>
    .page-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        color: var(--light);
    }
    
    .page-header p {
        color: var(--gray);
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 768px) {
        .controls-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .legend-content {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .legend-color.root-note {
        background: var(--secondary);
        border: 2px solid white;
    }
    
    .legend-color.scale-note {
        background: var(--primary);
        border: 2px solid white;
    }
    
    .legend-color.chord-note {
        background: #10b981;
        border: 2px solid white;
    }
    
    .legend-color.common-note {
        background: #fbbf24;
        border: 2px solid white;
    }
    
    .note-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .note-tag {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .note-tag.root {
        background: var(--secondary);
        color: white;
    }
    
    .note-tag.scale {
        background: var(--primary);
        color: white;
    }
    
    .note-tag.chord {
        background: #10b981;
        color: white;
    }
    
    .fretboard-container {
        overflow-x: auto;
        padding: 1rem;
        display: flex;
        justify-content: center;
        background: linear-gradient(180deg, #2d1810 0%, #1a0f0a 100%);
        border-radius: 12px;
        min-height: 320px;
    }
    
    .fretboard-container svg {
        max-width: 100%;
        height: auto;
    }
</style>

<script src="{{ url_for('static', filename='js/fretboard.js') }}"></script>
<script>
// Note frequencies for audio playback (A4 = 440Hz)
    const noteFrequencies = {
        'C': 261.63, 'C#': 277.18, 'Db': 277.18, 'D': 293.66, 'D#': 311.13, 'Eb': 311.13,
        'E': 329.63, 'F': 349.23, 'F#': 369.99, 'Gb': 369.99, 'G': 392.00,
        'G#': 415.30, 'Ab': 415.30, 'A': 440.00, 'A#': 466.16, 'Bb': 466.16, 'B': 493.88
    };
    
    // Tunings display info (high string to low string)
    const tuningInfo = {
        'standard': 'Standard: e B G D A E',
        'drop_d': 'Drop D: e B G D A D',
        'open_g': 'Open G: D B G D G D',
        'open_d': 'Open D: D A F# D A D',
        'half_step': 'Half Step: eb Bb Gb Db Ab Eb',
        'full_step': 'Full Step: D A F C G D'
    };
    
    // Audio context and settings - Fixed to triangle waveform, 1 second duration
    let audioContext = null;
    let currentWaveform = 'triangle';
    let currentDuration = 1;
    
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }
    
    // Get MIDI note number from note name and octave
    function getMidiNote(note, octave) {
        const noteMap = {
            'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3,
            'E': 4, 'F': 5, 'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8,
            'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
        };
        return 12 + (octave * 12) + (noteMap[note] || 0);
    }
    
    // Get frequency from MIDI note number
    function midiToFrequency(midi) {
        return 440 * Math.pow(2, (midi - 69) / 12);
    }
    
    // Play note with MIDI (most accurate for guitar fretboard)
    function playNoteWithMidi(midiNote) {
        initAudio();
        
        // Get frequency from MIDI note
        const frequency = midiToFrequency(midiNote);
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = currentWaveform;
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        
        // ADSR envelope for better sound
        const attack = 0.02;
        const decay = 0.05;
        const sustain = 0.7;
        const release = 0.1;
        const duration = currentDuration;
        
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
        gainNode.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
        gainNode.gain.setValueAtTime(0.3 * sustain, now + duration - release);
        gainNode.gain.linearRampToValueAtTime(0, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
        
        // Calculate note name and octave from MIDI for display
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteName = noteNames[midiNote % 12];
        const octave = Math.floor(midiNote / 12) - 1;
        console.log(`Playing: ${noteName}${octave} = ${frequency.toFixed(2)} Hz (MIDI: ${midiNote})`);
    }
    
    // NEW: Play note with explicit octave (for fretboard multi-octave support)
    function playNoteWithOctave(note, octave) {
        initAudio();
        
        // Get MIDI note and frequency
        const midiNote = getMidiNote(note, octave);
        const frequency = midiToFrequency(midiNote);
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = currentWaveform;
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        
        // ADSR envelope for better sound
        const attack = 0.02;
        const decay = 0.05;
        const sustain = 0.7;
        const release = 0.1;
        const duration = currentDuration;
        
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
        gainNode.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
        gainNode.gain.setValueAtTime(0.3 * sustain, now + duration - release);
        gainNode.gain.linearRampToValueAtTime(0, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
        
        console.log(`Playing: ${note}${octave} = ${frequency.toFixed(2)} Hz (MIDI: ${midiNote})`);
    }
    
    // Better playNote with proper octave calculation
    function playNote(note, stringIdx, fret) {
        initAudio();
        
        // Standard tuning base octaves (high e = 4, low E = 2)
        // stringIdx: 0 = high e, 5 = low E
        const baseMidiNotes = [64, 59, 55, 50, 45, 40]; // E4, B3, G3, D3, A2, E2
        
        // Calculate MIDI note: base + fret
        const midiNote = baseMidiNotes[stringIdx] + fret;
        const frequency = midiToFrequency(midiNote);
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = currentWaveform;
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        
        // ADSR envelope for better sound
        const attack = 0.02;
        const decay = 0.05;
        const sustain = 0.7;
        const release = 0.1;
        const duration = currentDuration;
        
        const now = audioContext.currentTime;
        gainNode.gain.setValueAtTime(0, now);
        gainNode.gain.linearRampToValueAtTime(0.3, now + attack);
        gainNode.gain.linearRampToValueAtTime(0.3 * sustain, now + attack + decay);
        gainNode.gain.setValueAtTime(0.3 * sustain, now + duration - release);
        gainNode.gain.linearRampToValueAtTime(0, now + duration);
        
        oscillator.start(now);
        oscillator.stop(now + duration);
    }
    
    // Play chord (multiple notes)
    function playChord(notes) {
        initAudio();
        notes.forEach((note, idx) => {
            setTimeout(() => {
                // Calculate string and fret from note position
                const baseMidiNotes = [64, 59, 55, 50, 45, 40];
                const stringIdx = idx % 6;
                const fret = Math.floor(idx / 6);
                const midiNote = baseMidiNotes[stringIdx] + fret;
                const frequency = midiToFrequency(midiNote);
                
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = currentWaveform;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(0.2, now + 0.02);
                gainNode.gain.linearRampToValueAtTime(0.1, now + 0.3);
                gainNode.gain.linearRampToValueAtTime(0, now + currentDuration);
                
                oscillator.start(now);
                oscillator.stop(now + currentDuration);
            }, idx * 50);
        });
    }
    
    // Initialize fretboard
    let fretboard = null;
    
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('fretboard-container');
        
        fretboard = new GuitarFretboard('fretboard-container', {
            numFrets: 15,
            tuning: 'standard',
            showFretNumbers: true,
            showStringNames: true,
            showFretMarkers: true,
            colorRoot: '#ec4899',
            colorScale: '#6366f1',
            colorChord: '#10b981',
            width: 900,
            height: 280,
            onNoteClick: function(noteInfo, stringIdx, fret) {
                // noteInfo can be either a string (old format) or object {note, octave, midi} (new format)
                let midiNote;
                if (typeof noteInfo === 'object' && noteInfo !== null && noteInfo.midi !== undefined) {
                    midiNote = noteInfo.midi;
                } else if (typeof noteInfo === 'object' && noteInfo !== null) {
                    // Fallback: calculate MIDI from note + octave
                    const note = noteInfo.note;
                    const octave = noteInfo.octave;
                    midiNote = getMidiNote(note, octave);
                } else {
                    midiNote = getMidiNote(noteInfo, 4);
                }
                playNoteWithMidi(midiNote);
            }
        });
        
        // Initial display
        displayFretboard();
    });
    
    // Event listeners
    const displayModeEl = document.getElementById('display-mode');
    const scaleOptionsEl = document.getElementById('scale-options');
    const chordOptionsEl = document.getElementById('chord-options');
    const chordRootOptionsEl = document.getElementById('chord-root-options');
    const commonLegendItemEl = document.getElementById('common-legend-item');
    const displayBtnEl = document.getElementById('display-btn');
    const tuningSelectEl = document.getElementById('tuning');
    const rootNoteEl = document.getElementById('root-note');
    const scaleTypeEl = document.getElementById('scale-type');
    const chordQualityEl = document.getElementById('chord-quality');
const chordRootNoteEl = document.getElementById('chord-root-note');
    const numFretsEl = document.getElementById('num-frets');
    const waveformEl = document.getElementById('waveform');
    const noteDurationEl = document.getElementById('note-duration');
    
    // Audio settings event listeners
    waveformEl.addEventListener('change', () => {
        currentWaveform = waveformEl.value;
    });
    
    noteDurationEl.addEventListener('change', () => {
        currentDuration = parseFloat(noteDurationEl.value);
    });
    
    displayModeEl.addEventListener('change', () => {
        const mode = displayModeEl.value;
        // Show/hide options based on mode
        scaleOptionsEl.style.display = (mode === 'scale' || mode === 'scale_chord') ? 'block' : 'none';
        chordOptionsEl.style.display = (mode === 'chord' || mode === 'scale_chord') ? 'block' : 'none';
        chordRootOptionsEl.style.display = mode === 'scale_chord' ? 'block' : 'none';
        commonLegendItemEl.style.display = mode === 'scale_chord' ? 'flex' : 'none';
    });
    
    tuningSelectEl.addEventListener('change', () => {
        const tuning = tuningSelectEl.value;
        fretboard.setTuning(tuning);
        
        // Update tuning info display
        document.getElementById('tuning-info').textContent = tuningInfo[tuning];
        
        displayFretboard();
    });
    
    numFretsEl.addEventListener('change', () => {
        const numFrets = parseInt(numFretsEl.value);
        fretboard.setNumFrets(numFrets);
        displayFretboard();
    });
    
    displayBtnEl.addEventListener('click', displayFretboard);
    
    // Play Scale functionality
    const playScaleBtnEl = document.getElementById('play-scale-btn');
    const stopScaleBtnEl = document.getElementById('stop-scale-btn');
    let isPlayingScale = false;
    let scalePlayTimeout = null;
    
    playScaleBtnEl.addEventListener('click', playScale);
    stopScaleBtnEl.addEventListener('click', stopScale);
    
// NEW: Play Chord MIDI button - with audio!
    const playChordBtnEl = document.getElementById('play-chord-btn');
    
    // Function to play chord with correct MIDI notes on fretboard
    function playChordFromFretboard(root, chordQuality) {
        const chordIntervals = {
            maj: [0, 4, 7],
            min: [0, 3, 7],
            dim: [0, 3, 6],
            aug: [0, 4, 8],
            dom7: [0, 4, 7, 10],
            maj7: [0, 4, 7, 11],
            min7: [0, 3, 7, 10],
            dim7: [0, 3, 6, 9],
            min7b5: [0, 3, 6, 10],
            '9': [0, 4, 7, 10, 14],
            maj9: [0, 4, 7, 11, 14],
            min9: [0, 3, 7, 10, 14],
            '11': [0, 4, 7, 10, 14, 17],
            '13': [0, 4, 7, 10, 14, 21]
        };
        
        const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const rootIndex = chromaticNotes.indexOf(root);
        const intervals = chordIntervals[chordQuality] || chordIntervals.maj;
        
        // Find all positions of chord notes on fretboard
        let chordMidiNotes = [];
        for (let stringIdx = 0; stringIdx < 6; stringIdx++) {
            for (let fret = 1; fret <= 15; fret++) {
                const info = fretboard.getNoteAtPosition(stringIdx, fret);
                if (intervals.some(i => chromaticNotes[(rootIndex + i) % 12] === info.note)) {
                    chordMidiNotes.push(info.midi);
                }
            }
        }
        
        // Play chord - all notes together
        initAudio();
        const now = audioContext.currentTime;
        
        // Play each note of the chord
        chordMidiNotes.slice(0, 6).forEach((midiNote, idx) => {
            const frequency = midiToFrequency(midiNote);
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = currentWaveform;
            oscillator.frequency.setValueAtTime(frequency, now);
            
            // Stagger slightly for strum effect
            const delay = idx * 0.03;
            gainNode.gain.setValueAtTime(0, now + delay);
            gainNode.gain.linearRampToValueAtTime(0.15, now + delay + 0.02);
            gainNode.gain.setValueAtTime(0.15, now + delay + 0.5);
            gainNode.gain.linearRampToValueAtTime(0, now + delay + currentDuration);
            
            oscillator.start(now + delay);
            oscillator.stop(now + delay + currentDuration);
        });
    }
    
    playChordBtnEl.addEventListener('click', function() {
        const root = rootNoteEl.value;
        const chordQuality = chordQualityEl.value;
        
        // Play the chord audio
        playChordFromFretboard(root, chordQuality);
        
        // Use the new highlightChordMidi method
        fretboard.highlightChordMidi(root, chordQuality, 2000); // Highlight for 2 seconds
    });
    
    function stopScale() {
        isPlayingScale = false;
        if (scalePlayTimeout) {
            clearTimeout(scalePlayTimeout);
            scalePlayTimeout = null;
        }
        playScaleBtnEl.style.display = 'block';
        stopScaleBtnEl.style.display = 'none';
    }
    
    function playScale() {
        if (isPlayingScale) return;
        
        const mode = displayModeEl.value;
        if (mode !== 'scale') {
            alert('Please select Scale mode to play');
            return;
        }
        
        isPlayingScale = true;
        playScaleBtnEl.style.display = 'none';
        stopScaleBtnEl.style.display = 'block';
        
        const root = rootNoteEl.value;
        const scaleType = scaleTypeEl.value;
        
        // Get scale intervals
        const intervals = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor_natural: [0, 2, 3, 5, 7, 8, 10],
            minor_harmonic: [0, 2, 3, 5, 7, 8, 11],
            minor_melodic: [0, 2, 3, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            pentatonic_major: [0, 2, 4, 7, 9],
            pentatonic_minor: [0, 3, 5, 7, 10],
            blues_minor: [0, 3, 5, 6, 7, 10],
            blues_major: [0, 2, 3, 4, 7, 9]
        };
        
        const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const rootIndex = chromaticNotes.indexOf(root);
        const scaleIntervals = intervals[scaleType] || intervals.major;
        
        // Get scale notes with octaves for playing (play 2 octaves)
        const scaleNotes = [];
        
        // First octave
        for (let i = 0; i < scaleIntervals.length; i++) {
            const midiNote = 60 + scaleIntervals[i]; // Start from C4 (MIDI 60)
            scaleNotes.push(midiNote);
        }
        
        // Second octave
        for (let i = 0; i < scaleIntervals.length; i++) {
            const midiNote = 72 + scaleIntervals[i]; // Start from C5 (MIDI 72)
            scaleNotes.push(midiNote);
        }
        
        // Play scale with animation
        let noteIndex = 0;
        const noteDuration = currentDuration * 1000; // Convert to ms
        
        function playNextNote() {
            if (!isPlayingScale || noteIndex >= scaleNotes.length) {
                stopScale();
                return;
            }
            
            const midiNote = scaleNotes[noteIndex];
            playNoteWithMidi(midiNote);
            
            // Highlight the note on fretboard with MIDI for precise position
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteName = noteNames[midiNote % 12];
            fretboard.highlightNoteTemporary(noteName, 300, midiNote);
            
            noteIndex++;
            scalePlayTimeout = setTimeout(playNextNote, noteDuration);
        }
        
        playNextNote();
    }
    
    function displayFretboard() {
        const root = rootNoteEl.value;
        const mode = displayModeEl.value;
        
        let activeNotes = [];
        let activeNoteType = {};
        
        const chromaticNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        if (mode === 'scale') {
            const scaleType = scaleTypeEl.value;
            fretboard.highlightScale(root, scaleType);
            
            // Get scale notes for display
            const intervals = {
                major: [0, 2, 4, 5, 7, 9, 11],
                minor_natural: [0, 2, 3, 5, 7, 8, 10],
                minor_harmonic: [0, 2, 3, 5, 7, 8, 11],
                minor_melodic: [0, 2, 3, 5, 7, 9, 11],
                dorian: [0, 2, 3, 5, 7, 9, 10],
                phrygian: [0, 1, 3, 5, 7, 8, 10],
                lydian: [0, 2, 4, 6, 7, 9, 11],
                mixolydian: [0, 2, 4, 5, 7, 9, 10],
                locrian: [0, 1, 3, 5, 6, 8, 10],
                pentatonic_major: [0, 2, 4, 7, 9],
                pentatonic_minor: [0, 3, 5, 7, 10],
                blues_minor: [0, 3, 5, 6, 7, 10],
                blues_major: [0, 2, 3, 4, 7, 9]
            };
            
            const rootIndex = chromaticNotes.indexOf(root);
            const scaleIntervals = intervals[scaleType] || intervals.major;
            activeNotes = scaleIntervals.map(i => chromaticNotes[(rootIndex + i) % 12]);
            activeNotes.forEach(n => activeNoteType[n] = 'scale');
            activeNoteType[root] = 'root';
            
        } else if (mode === 'chord') {
            const chordQuality = chordQualityEl.value;
            fretboard.highlightChord(root, chordQuality);
            
            // Get chord notes for display
            const intervals = {
                maj: [0, 4, 7],
                min: [0, 3, 7],
                dim: [0, 3, 6],
                aug: [0, 4, 8],
                dom7: [0, 4, 7, 10],
                maj7: [0, 4, 7, 11],
                min7: [0, 3, 7, 10],
                dim7: [0, 3, 6, 9],
                min7b5: [0, 3, 6, 10],
                '9': [0, 4, 7, 10, 14],
                maj9: [0, 4, 7, 11, 14],
                min9: [0, 3, 7, 10, 14],
                '11': [0, 4, 7, 10, 14, 17],
                '13': [0, 4, 7, 10, 14, 21]
            };
            
            const rootIndex = chromaticNotes.indexOf(root);
            const chordIntervals = intervals[chordQuality] || intervals.maj;
            activeNotes = chordIntervals.map(i => chromaticNotes[(rootIndex + i) % 12]);
            activeNotes.forEach(n => activeNoteType[n] = 'chord');
            activeNoteType[root] = 'root';
            
        } else if (mode === 'scale_chord') {
            // NEW: Scale + Chord combined mode
            const scaleType = scaleTypeEl.value;
            const chordQuality = chordQualityEl.value;
            const chordRoot = chordRootNoteEl.value;
            
            // Get scale intervals
            const scaleIntervals = {
                major: [0, 2, 4, 5, 7, 9, 11],
                minor_natural: [0, 2, 3, 5, 7, 8, 10],
                minor_harmonic: [0, 2, 3, 5, 7, 8, 11],
                minor_melodic: [0, 2, 3, 5, 7, 9, 11],
                dorian: [0, 2, 3, 5, 7, 9, 10],
                phrygian: [0, 1, 3, 5, 7, 8, 10],
                lydian: [0, 2, 4, 6, 7, 9, 11],
                mixolydian: [0, 2, 4, 5, 7, 9, 10],
                locrian: [0, 1, 3, 5, 6, 8, 10],
                pentatonic_major: [0, 2, 4, 7, 9],
                pentatonic_minor: [0, 3, 5, 7, 10],
                blues_minor: [0, 3, 5, 6, 7, 10],
                blues_major: [0, 2, 3, 4, 7, 9]
            };
            
            // Get chord intervals
            const chordIntervals = {
                maj: [0, 4, 7],
                min: [0, 3, 7],
                dim: [0, 3, 6],
                aug: [0, 4, 8],
                dom7: [0, 4, 7, 10],
                maj7: [0, 4, 7, 11],
                min7: [0, 3, 7, 10],
                dim7: [0, 3, 6, 9],
                min7b5: [0, 3, 6, 10],
                '9': [0, 4, 7, 10, 14],
                maj9: [0, 4, 7, 11, 14],
                min9: [0, 3, 7, 10, 14],
                '11': [0, 4, 7, 10, 14, 17],
                '13': [0, 4, 7, 10, 14, 21]
            };
            
            const scaleRootIdx = chromaticNotes.indexOf(root);
            const chordRootIdx = chromaticNotes.indexOf(chordRoot);
            
            const scaleInterv = scaleIntervals[scaleType] || scaleIntervals.major;
            const chordInterv = chordIntervals[chordQuality] || chordIntervals.maj;
            
            const scaleNotes = scaleInterv.map(i => chromaticNotes[(scaleRootIdx + i) % 12]);
            const chordNotes = chordInterv.map(i => chromaticNotes[(chordRootIdx + i) % 12]);
            
            // Find common notes
            const commonNotes = scaleNotes.filter(n => chordNotes.includes(n));
            
            // Mark scale-only notes
            scaleNotes.forEach(n => {
                if (!commonNotes.includes(n)) {
                    activeNotes.push(n);
                    activeNoteType[n] = 'scale';
                }
            });
            
            // Mark chord-only notes
            chordNotes.forEach(n => {
                if (!commonNotes.includes(n)) {
                    activeNotes.push(n);
                    activeNoteType[n] = 'chord';
                }
            });
            
            // Mark common notes
            commonNotes.forEach(n => {
                if (!activeNotes.includes(n)) {
                    activeNotes.push(n);
                }
                activeNoteType[n] = 'common';
            });
            
            // Mark roots
            activeNoteType[root] = 'root';
            activeNoteType[chordRoot] = 'root';
            if (!activeNotes.includes(root)) activeNotes.push(root);
            if (!activeNotes.includes(chordRoot)) activeNotes.push(chordRoot);
            
            // Call the combined highlight method
            fretboard.highlightScaleAndChord(root, scaleType, chordRoot, chordQuality);
            
        } else {
            // Show all notes
            activeNotes = [...chromaticNotes];
            activeNotes.forEach(n => activeNoteType[n] = 'scale');
            fretboard.highlightNotes(activeNotes, 'scale');
        }
        
        // Update legend
        const notesContainer = document.getElementById('displayed-notes');
        notesContainer.innerHTML = activeNotes.map(n => {
            const type = activeNoteType[n] || 'scale';
            return `<span class="note-tag ${type}">${n}</span>`;
        }).join('');
    }
</script>
{% endblock %}

